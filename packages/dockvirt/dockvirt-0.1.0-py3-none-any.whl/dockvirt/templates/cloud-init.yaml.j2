#cloud-config
# Ensure user exists and is in the docker group
users:
  - name: '{{ remote_user }}'
    groups: docker
    sudo: ALL=(ALL) NOPASSWD:ALL

# Update packages and install prerequisites
package_update: true
package_upgrade: true
packages:
  - curl

# Write Docker Compose and Caddy files
write_files:
  - path: /home/{{ remote_user }}/docker-compose.yml
    content: |
{{ docker_compose_content | indent(6) }}
  - path: /home/{{ remote_user }}/Caddyfile
    content: |
{{ caddyfile_content | indent(6) }}

# Install Docker, set permissions, and run containers
runcmd:
  - curl -fsSL https://get.docker.com -o get-docker.sh
  - sh get-docker.sh
  - chown {{ remote_user }}:{{ remote_user }} /home/{{ remote_user }}/docker-compose.yml
  - chown {{ remote_user }}:{{ remote_user }} /home/{{ remote_user }}/Caddyfile
  - runuser -l {{ remote_user }} -c 'cd /home/{{ remote_user }} && docker compose up -d'
