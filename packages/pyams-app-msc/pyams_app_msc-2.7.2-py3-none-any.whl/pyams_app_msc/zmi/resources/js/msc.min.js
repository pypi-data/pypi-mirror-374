"use strict";void 0===window.$&&(window.$=MyAMS.$);const msc={catalog:{changeActivity:e=>{const t=$("html").attr("lang"),a=$(e.currentTarget).parents("form"),n=$('select[name$=".widgets.reference"]',a),r=n.val(),s=$(`input[name$=".widgets.${t}.title"]`,a),o=$('select[name$=".widgets.data_type"]',a);r&&MyAMS.require("ajax").then(()=>{MyAMS.ajax.get(`${window.location.origin}/api/content/rest/${r}/internal`,{included:"catalog_entry"}).then(e=>{s.val(e.info.title),e.info.data_type&&o.val(e.info.data_type.id).trigger("change")})})},getPrincipalID:e=>{const t=$(e.currentTarget),a=t.siblings("select"),n=a.val();MyAMS.require("modal").then(()=>{MyAMS.modal.open("edit-user-profile.html?principal_id="+n)})},setIllustration:(e,t,a)=>{const n=$(e.currentTarget),r=n.html(),s=n.parents(".media-thumbnail"),o=s.parents(".gallery"),l=o.data("ams-location");MyAMS.require("ajax","alert","i18n").then(()=>{MyAMS.alert.bigBox({status:"warning",icon:"fas fa-bell",title:MyAMS.i18n.WARNING,message:"Confirmez-vous le remplacement de l'illustration ?",successLabel:MyAMS.i18n.CONFIRM,cancelLabel:MyAMS.i18n.BTN_CANCEL}).then(e=>{"success"===e&&(n.html('<i class="fas fa-fw fa-spinner fa-spin"></i>'),MyAMS.ajax.post(l+`/set-${a}-illustration.json`,{object_name:s.data("ams-element-name")}).then(e=>{MyAMS.alert.smallBox({status:e.status,message:e.message,icon:"fa-info-circle",timeout:3e3}),n.html(r)}).catch(()=>{n.html(r)}))})})},setContentIllustrationFromGallery:(e,t)=>{msc.catalog.setIllustration(e,t,"content")},setLinkIllustrationFromGallery:(e,t)=>{msc.catalog.setIllustration(e,t,"link")}},session:{setProgramLength:e=>{const t=$(e.currentTarget),a=t.data("msc-length");MyAMS.require("ajax").then(()=>{MyAMS.ajax.post("set-my-program-length.json",{length:a}).then(MyAMS.ajax.handleJSON)})},confirmDelete:t=>{MyAMS.require("ajax","alert","i18n","form").then(()=>{MyAMS.alert.bigBox({status:"danger",icon:"fas fa-bell",title:"Confirmez-vous la suppression de cette séance ?",message:"Cette séance a fait l'objet de plusieurs demandes de réservations.<br />Si vous la supprimez, l'ensemble des réservations qui s'y appliquent seront également supprimées !"}).then(e=>{"success"===e&&(e=t.parents("form"),MyAMS.form.submit(e))})})},changeActivity:e=>{$("html").attr("lang");const n=$(e.currentTarget).parents("form"),t=$('select[name$=".widgets.activity"]',n),a=t.val();a&&MyAMS.require("ajax").then(()=>{MyAMS.ajax.get(`${window.location.origin}/api/content/rest/${a}/internal`,{included:"catalog_entry"}).then(e=>{var t,a,e=e.info?.catalog_entry?.duration;e&&(a=$('input[name$=".widgets.start_date"]',n),a=new Date(a.val()),t=$('input[id$="-widgets-end_date-dt"]',n),a=new Date(a.getTime()+6e4*e),t.data("datetimepicker").date(a))})})},roomChanged:(e,t)=>{const a=t.theater_name,n=$(e.currentTarget).val();MyAMS.require("ajax").then(()=>{MyAMS.ajax.get(`${window.location.origin}/api/msc/${a}/room/`+n).then(e=>{e=e.room?.capacity;e&&$(`input[id="${t.target}"]`).val(e)})})}},calendar:{transposed:"true"===localStorage.getItem("msc.transposed"),synchronized:"true"===localStorage.getItem("msc.synchronized"),scrolling:"true"===localStorage.getItem("msc.scrolling"),initCalendar:(e,t,a,n)=>{a.viewDidMount=MyAMS.msc.calendar.onMountedView,a.eventContent=MyAMS.msc.calendar.setEventContent,a.eventClassNames=MyAMS.msc.calendar.setEventClassNames,a.eventDidMount=MyAMS.msc.calendar.renderedEvent,a.dateClick=MyAMS.msc.calendar.addEvent,a.eventClick=MyAMS.msc.calendar.showEvent,a.eventDrop=MyAMS.msc.calendar.dropEvent,a.eventResize=MyAMS.msc.calendar.resizeEvent,a.eventReceive=MyAMS.msc.calendar.receiveEvent,a.datesSet=MyAMS.msc.calendar.setDates},onMountedView:e=>{MyAMS.msc.calendar.scrolling&&(e=$(e.el),$(".fc-scroller",e).off("scroll").on("scroll",e=>{e=$(e.currentTarget).scrollTop();$(".fc-scroller",$(".calendar tbody td")).scrollTop(e)}))},refresh:(e,t)=>{"object"==typeof t&&(e=t.room_id);t=$(`.calendar[data-msc-room="${e}"]`).data("msc-calendar");t&&t.refetchEvents()},refreshAll:()=>{$(".calendar").each((e,t)=>{$(t).data("msc-calendar").refetchEvents()})},afterInit:(e,t,a)=>{var n;msc.calendar.transposed&&($(".calendar-wrapper").addClass("transposed"),(n=$('a[href="MyAMS.msc.calendar.transpose"]')).exists())&&n.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary"),msc.calendar.synchronized&&(n=$('a[href="MyAMS.msc.calendar.synchronize"]')).exists()&&n.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary"),msc.calendar.scrolling&&(n=$('a[href="MyAMS.msc.calendar.scroll"]')).exists()&&n.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary")},afterInitCalendar:(e,t,a)=>{t.data("msc-calendar",a)},setEventContent:e=>{var e=e.event,t=e.title.split("\n");return 1<t.length?{html:`<strong>${t[0]}</strong><br />`+(t[1]||"")}:t[0]?"background"===e.display?{html:`<span class="small">${t[0]}</span>`}:{html:`<strong>${t[0]}</strong>`}:{html:"--"}},setEventClassNames:e=>{e=e.event.extendedProps;let t="";return e.temporary&&(t="font-italic"),e.zIndex&&(t+=" z-index-"+e.zIndex),e.opacity&&(t+=` opacity-${e.opacity}-imp`),e.borderWidth&&(t+=" border-"+e.borderWidth),e.borderStyle&&(t+=" border-"+e.borderStyle),e.backgroundImage&&(t+=" event-bg-"+e.backgroundImage),t},renderedEvent:e=>{var t=e.event,e=$(e.el),t=(!1!==t.extendedProps.contextMenu&&e.data("msc-event",t).contextMenu({menuSelector:"#eventMenu"}),t.title.split("\n"));1<t.length?e.tooltip({title:`<strong>${t[0]}</strong><br />Places: `+(t[1].replace(/\(/,"").replace(/\)/,"")||""),html:!0}):t[0]?e.tooltip({title:`<strong>${t[0]}</strong>`,html:!0}):e.tooltip({title:"--",html:!1})},switchDisplay:e=>{var e=$(e.currentTarget),t=e.parents(".calendar-parent"),a=t.parents(".calendar-wrapper");t.toggleClass("col").toggleClass("border").toggleClass("rounded"),a.hasClass("transposed")?(t.hasClass("border")?MyAMS.core.switchIcon($("i",e),"angle-right","angle-down"):MyAMS.core.switchIcon($("i",e),"angle-down","angle-right"),t.toggleClass("mh-400px")):t.toggleClass("w-100").toggleClass("mx-1"),msc.calendar.refreshAll()},transpose:e=>{var t=$(".calendar-wrapper"),e=(t.toggleClass("transposed"),$(".calendar").each((e,t)=>{$(t).data("msc-calendar").render()}),e.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary"),t.hasClass("transposed"));localStorage.setItem("msc.transposed",e),msc.calendar.transposed=e},synchronize:e=>{if(msc.calendar.synchronized=!msc.calendar.synchronized,msc.calendar.synchronized){const t=$(".calendar"),a=t.first().data("msc-calendar");try{msc.calendar.synchronized=!1,t.each((e,t)=>{0!==e&&$(t).data("msc-calendar").changeView(a.view.type,a.view.currentStart)})}finally{msc.calendar.synchronized=!0}}e.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary"),localStorage.setItem("msc.synchronized",e.hasClass("btn-secondary"))},scroll:e=>{const t=$(".fc-scroller",$(".calendar tbody td"));msc.calendar.scrolling=!msc.calendar.scrolling,msc.calendar.scrolling?t.on("scroll",e=>{e=$(e.currentTarget).scrollTop();t.scrollTop(e)}):t.off("scroll"),e.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary"),localStorage.setItem("msc.scrolling",e.hasClass("btn-secondary"))},updating:[],setDates:a=>{if($(".tooltip").tooltip("hide"),msc.calendar.synchronized){const n=msc.calendar.updating;if(!(-1<n.indexOf(a.view.calendar))){n.push(a.view.calendar);var e=$(".calendar");try{e.each((e,t)=>{t=$(t).data("msc-calendar");!t||-1<n.indexOf(t)||t===a.view.calendar||t.changeView(a.view.type,a.view.currentStart)})}finally{setTimeout(function(){msc.calendar.updating.splice(0,msc.calendar.updating.length)},50)}}}},addEvent:e=>{const t=e.jsEvent.target,a=$(t).parents(".calendar"),n=a.data("msc-room");$(".tooltip").tooltip("hide"),"True"===a.data("msc-editable")&&MyAMS.require("modal").then(()=>{MyAMS.modal.open("add-session.html",{start:e.dateStr,room:n})})},cloneEvent:(e,t)=>()=>{$(".tooltip").tooltip("hide"),MyAMS.require("ajax").then(()=>{var e=t.data("msc-event");MyAMS.ajax.post(e.extendedProps.href+"/clone-event.json").then(e=>{"success"===e.status&&MyAMS.msc.calendar.refresh(e.event.room)})})},addEventCallback:(e,t)=>{t=t.event.room;$(".tooltip").tooltip("hide"),MyAMS.msc.calendar.refresh(t)},showEvent:e=>{var e=e.event,t=e.extendedProps?.visible;if($(".tooltip").tooltip("hide"),t){const a=e.extendedProps?.href;a&&MyAMS.require("modal").then(()=>{MyAMS.modal.open(a+"/properties.html")})}},editEventCallback:(e,t)=>{const n=t.event,r=n.room.toString(),a=$(".calendar");$(".tooltip").tooltip("hide"),a.each((e,t)=>{var t=$(t),a=t.data("msc-room").toString(),t=t.data("msc-calendar");a===r?t.refetchEvents():(a=t.getEventById(n.id))&&a.remove()})},dropEvent:r=>($(".tooltip").tooltip("hide"),new Promise((t,e)=>{const a=r.event,n=a.extendedProps?.href;n?MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(n+"/update-event.json",{room:a.extendedProps.room.toString(),start:a.startStr,end:a.endStr}).then(e=>{t(e)},()=>{r.revert(),e()})}):(r.revert(),e())})),resizeEvent:r=>($(".tooltip").tooltip("hide"),new Promise((t,e)=>{const a=r.event,n=a.extendedProps?.href;n?MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(n+"/update-event.json",{room:a.extendedProps.room.toString(),start:a.startStr,end:a.endStr}).then(e=>{t(e)},()=>{r.revert(),e()})}):(r.revert(),e())})),receiveEvent:i=>($(".tooltip").tooltip("hide"),new Promise((t,e)=>{const a=i.event,n=a.extendedProps?.href;if(n){const r=$(i.view.calendar.el),s=r.data("msc-calendar"),o=r.data("msc-room"),l=a.extendedProps?.room,c=$(`.calendar[data-msc-room="${l}"]`).data("msc-calendar");MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(n+"/update-event.json",{room:o.toString(),start:a.startStr,end:a.endStr}).then(e=>{i.revert(),c.refetchEvents(),s.refetchEvents(),e.messagebox?MyAMS.require("alert").then(()=>{MyAMS.alert.messageBox(e.messagebox),t(e)}):t(e)},()=>{i.revert(),c.refetchEvents(),s.refetchEvents(),e()})})}else i.revert(),e()})),deleteEventCallback:(e,t)=>{t=$(`.calendar[data-msc-room="${t.room}"]`).data("msc-calendar")?.getEventById(t.event_id);$(".tooltip").tooltip("hide"),t&&t.remove()},manageEventBookings:(e,t)=>()=>{const e=t.data("msc-event");MyAMS.require("modal").then(()=>{MyAMS.modal.open(e.extendedProps.href+"/bookings.html")})},changeEventActivity:(e,t)=>()=>{const e=t.data("msc-event");MyAMS.require("modal").then(()=>{MyAMS.modal.open(e.extendedProps.href+"/set-session-activity.html")})}},booking:{seatsChanged:(e,t)=>{var a=parseInt($('[id="form-widgets-nb_participants"]').val())||0,n=parseInt($('[id="form-widgets-nb_accompanists"]').val())||0;$(`[id="${t.target}"]`).val(a+n)},priceChanged:s=>{MyAMS.require("ajax").then(()=>{const e=s.select2,t=e.val(),a=$(e.$element).parents("form"),n=$('input[name="form.widgets.accompanying_ratio"]',a),r={};t&&"--NOVALUE--"!==t?(r[s.amsSelect2HelperArgument]=t,MyAMS.ajax.get(s.amsSelect2HelperUrl,r).then(e=>{n.val(e.price.accompanying_ratio)})):n.val(null)})},changeSession:(e,t)=>{var a;t.old_session!==t.new_session&&(t=t.row_id,(a=(t=$(`tr[id="${t}"]`)).parents("table")).hasClass("datatable")?a.DataTable().row(t).remove().draw():t.remove()),MyAMS.msc.calendar.refreshAll()},previewQuotation:(s,o)=>{MyAMS.require("ajax","alert").then(()=>{var e=$(s.currentTarget).parents("form"),t=$('input[name="form.widgets.nb_participants"]',e).val(),a=$('input[name="form.widgets.nb_accompanists"]',e).val(),n=$('input[name="form.widgets.nb_free_accompanists"]',e).val(),r=$('select[name="form.widgets.price"]',e).val(),e=$('input[name="form.widgets.accompanying_ratio"]',e).val();t&&a&&r&&"--NOVALUE--"!==r?window.open(o.target+"?"+`nb_participants=${t}&`+`nb_accompanists=${a}&`+`nb_free_accompanists=${n}&`+`price=${r}&`+"ratio="+(e||0),"_blank"):MyAMS.alert.messageBox({status:"error",title:"Prévisualisation impossible !",message:"Vous devez définir le nombre de participants et sélectionner un tarif pour pouvoir prévisualiser le devis..."})})},resetQuotation:(e,t)=>{const a=t.target;MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(a,{}).then(MyAMS.ajax.handleJSON)})}}};window.MyAMS&&(MyAMS.config.modules.push("msc"),MyAMS.msc=msc,console.debug("MyAMS: MSC module loaded..."));