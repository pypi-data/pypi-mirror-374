"use strict";(self.webpackChunk_jupyterlab_nbgallery_gallerymenu=self.webpackChunk_jupyterlab_nbgallery_gallerymenu||[]).push([[270],{270:(e,t,a)=>{a.r(t),a.d(t,{default:()=>k});var l=a(517),i=a(436),o=a(256),n=a(980),s=a(566),r=a(397),d=a(10),h=a(345);class u extends i.ReactWidget{constructor(){super(),this.addClass("jp-ReactWidget")}render(){return h.createElement("div",{dangerouslySetInnerHTML:{__html:this.content}})}}var c=a(76),g=a.n(c);const b={id:"@jupyterlab-nbgallery/gallerymenu",autoStart:!0,requires:[l.IMainMenu,n.INotebookTracker,d.ISettingRegistry],activate:function(e,t,a,l){if(a){switch(r.PageConfig.getOption("notebookPage")){case"tree":case"terminals":case"consoles":return}new y(e,t,a,l)}}};class y{constructor(e,t,a,l){this.dialogPromiseCache=new Map,this.gallery_url="",this.app=e,this.mainMenu=t,this.notebooks=a,this.settingsRegistry=l,Promise.all([this.app.restored,this.settingsRegistry.load("@jupyterlab-nbgallery/environment-registration:environment-registration")]).then(([,e])=>{this.settings=e,this.initialize()})}async initialize(){const e=s.ServerConnection.makeSettings(),t=r.URLExt.join(e.baseUrl,"jupyterlab_nbgallery","environment");this.gallery_url=this.settings.get("nbgallery_url").composite;let a=this;await g().ajax({method:"GET",headers:{Accept:"application/json"},url:t,cache:!1,xhrFields:{withCredentials:!0},success:function(e){""==a.gallery_url&&(a.gallery_url=e.NBGALLERY_URL),a.default_tags=e.DEFAULT_TAGS}}),this.gallery_menu=this.buildMenus(),this.mainMenu.addMenu(this.gallery_menu,!0,{rank:50}),setTimeout(this.gallery_menu.update,4e3)}getGalleryMetadata(e){return e.model.sharedModel.metadata.gallery}setGalleryMetadata(e,t){e.model.sharedModel.setMetadata("gallery",t),this.triggerSave()}updateMetadata(e,t,a){let l=t&&t.link,i=t&&t.clone;t||(t={}),t.commit=a.commit,t.staging_id=a.staging_id,a.link?t.uuid=a.link:t.uuid=a.clone,l?t.link=t.uuid:i?t.clone=t.uuid:a.link?t.link=t.uuid:a.clone&&(t.clone=t.uuid),this.setGalleryMetadata(e,t),this.triggerSave()}triggerSave(){this.notebooks.currentWidget===this.app.shell.currentWidget&&this.notebooks.currentWidget.context.save()}stripOutput(e){let t=JSON.parse(e.model.toString());var a;for(a in t.cells)"code"==t.cells[a].cell_type?(t.cells[a].outputs=[],t.cells[a].execution_count=null):null!=t.cells[a].outputs&&delete t.cells[a].outputs;return t}async checkForUpdates(e,t){let a=this.getGalleryMetadata(e);try{let e=r.URLExt.join(t.href,"notebooks",a.uuid,"metadata");return(await g().ajax({method:"GET",url:e,headers:{Accept:"application/json"},xhrFields:{withCredentials:!0}})).commit_id!=a.commit}catch(e){(0,i.showErrorMessage)("Staging Failed","An error occured checking for updates to the specified notebook.  Please ensure that you are logged in to the Gallery.")}}async diffCallback(){let e=[],t=this.getGalleryLink(),a=this.currentNotebook(),l=this.getGalleryMetadata(a);e[e.length]=i.Dialog.cancelButton({label:"Close"});let o=new u,n=await g().ajax({method:"POST",url:r.URLExt.join(t.href,"notebooks",l.uuid,"diff").toString(),dataType:"json",contentType:"text/plain",headers:{accept:"application/json"},data:JSON.stringify(this.stripOutput(a)),xhrFields:{withCredentials:!0}});n.different?o.content="<div style='color:#000'>"+n.css+n.inline+"</div>":o.content="<div>No Changes</div>";const s=l.uuid+"changedDialog",d=this.dialogPromiseCache.get(s);if(d)return d;{const t=(0,i.showDialog)({title:"Diff with Remote Notebook",body:o,buttons:e}).then(async e=>{this.dialogPromiseCache.delete(s)},e=>{throw this.dialogPromiseCache.delete(s),e});return this.dialogPromiseCache.set(s,t),t}}async changedDialog(e){let t=[],a=this.getGalleryLink(),l=this.currentNotebook(),o=this.getGalleryMetadata(l);t[t.length]=i.Dialog.cancelButton({label:"Cancel"}),e||(t[t.length]=i.Dialog.okButton({label:"View Diff"})),t[t.length]=i.Dialog.okButton({label:"Download and Replace Local",displayType:"warn"}),o.link&&(t[t.length]=i.Dialog.okButton({label:"Upload and Replace Remote",displayType:"warn"}));let n=new u;if(e){let e=await g().ajax({method:"POST",url:r.URLExt.join(a.href,"notebooks",o.link,"/diff").toString(),dataType:"json",contentType:"text/plain",headers:{accept:"application/json"},data:JSON.stringify(this.stripOutput(l)),xhrFields:{withCredentials:!0}});n.content="<div style='color:#000'>"+e.css+e.inline+"</div>"}else n.content="The <a href='"+r.URLExt.join(a.toString(),"notebooks",o.uuid).toString()+"' target='_blank'>Remote Notebook</a> has changed on Notebook Gallery.  What do you want to do?";const s=o.uuid+"changedDialog",d=this.dialogPromiseCache.get(s);if(d)return d;{const e=(0,i.showDialog)({title:"Remote Notebook Has Changed",body:n,buttons:t}).then(async e=>{if(this.dialogPromiseCache.delete(s),"Download and Replace Local"==e.button.label)this.downloadReplace(l,a);else if("Upload and Replace Remote"==e.button.label){this.triggerSave();let e=await this.stageNotebook(l,a,o.uuid);e&&(this.finishUpload(l,o,e,a,!1,""),this.updateMetadata(l,o,e))}else"View Diff"==e.button.label&&this.changedDialog(!0)},e=>{throw this.dialogPromiseCache.delete(s),e});return this.dialogPromiseCache.set(s,e),e}}async downloadReplace(e,t){let a=this.getGalleryMetadata(e),l=r.URLExt.join(t.href,"notebooks",a.uuid,"download");try{let t=await g().ajax({method:"GET",headers:{Accept:"application/json"},url:l,cache:!1,xhrFields:{withCredentials:!0}}),i=JSON.parse(t);a.link&&(i.metadata.gallery.link=a.link,i.metadata.gallery.clone=null),e.model.fromJSON(i),this.triggerSave()}catch(e){(0,i.showErrorMessage)("Download Error","An error occured attempting to download the specified notebook.")}}async stageNotebook(e,t,a){let l="";console.log("Attempting to stage"),l=r.URLExt.join(t.href,"stages?agree=yes").toString(),a&&a.length>0&&(l=l+"&id="+a);try{return await g().ajax({method:"POST",url:l,dataType:"json",contentType:"text/plain",headers:{Accept:"application/json"},xhrFields:{withCredentials:!0},data:JSON.stringify(this.stripOutput(e))})}catch(e){return void(0,i.showErrorMessage)("Staging Failed","An error occured attempting to upload the specified notebook.  Please ensure that you are logged in to the Gallery.")}}finishUpload(e,t,a,l,i,o){t?i?window.open(r.URLExt.join(l.toString(),"notebook",t.uuid,"?staged="+a.staging_id+"#CHANGE_REQ").toString()):t.link?window.open(r.URLExt.join(l.toString(),"notebook",t.link,"?staged="+a.staging_id+"#UPDATE").toString()):window.open(r.URLExt.join(l.toString(),"?staged="+a.staging_id+"&parent_uuid="+t.parent_uuid+"#STAGE").toString()):window.open(r.URLExt.join(l.toString(),"?staged="+a.staging_id+"&tags="+encodeURIComponent(o)+"#STAGE").toString())}async uploadCallback(){let e;this.triggerSave(),e=this.currentNotebook();let t=this.getGalleryMetadata(e),a=this.getGalleryLink(),l=await this.stageNotebook(e,a,null),i=this.default_tags;l&&(this.finishUpload(e,t,l,a,!1,i),this.updateMetadata(e,t,l))}async saveCallback(){let e;this.triggerSave(),e=this.currentNotebook();let t=this.getGalleryMetadata(e),a=this.getGalleryLink();if(await this.checkForUpdates(e,a))this.changedDialog(!1);else{let l=await this.stageNotebook(e,a,t.uuid);l&&(this.finishUpload(e,t,l,a,!1,""),this.updateMetadata(e,t,l))}}async changereqCallback(){let e;this.triggerSave(),e=this.currentNotebook();let t=this.getGalleryMetadata(e),a=this.getGalleryLink(),l=await this.stageNotebook(e,a,t.uuid);l&&(this.finishUpload(e,t,l,a,!0,""),this.updateMetadata(e,t,l))}async changesCallback(){let e;this.triggerSave(),e=this.currentNotebook();let t=this.getGalleryLink();await this.checkForUpdates(e,t)&&this.changedDialog(!1)}async linkCallback(){i.InputDialog.getText({title:"Please enter the Notebook URL"}).then(e=>{this.linkNotebookIfExists(this.currentNotebook(),e.value)})}async linkNotebookIfExists(e,t){let a=this,l=new URL(t),i=r.URLExt.join(t,"uuid");g().ajax({method:"GET",headers:{Accept:"application/json"},url:i,cache:!1,xhrFields:{withCredentials:!0},success:function(t){if(null!=t){let i=r.URLExt.join(l.origin,"notebooks",t.uuid,"metadata");g().ajax({method:"GET",headers:{Accept:"application/json"},url:i,cache:!1,xhrFields:{withCredentials:!0},success:function(t){a.setGalleryMetadata(e,{uuid:t.uuid,git_commit_id:t.commit_id,gallery_url:l.origin}),a.triggerSave()}})}},error:function(){console.error("Notebook not found")}})}async unlinkCallback(){i.InputDialog.getBoolean({title:"Are you sure you want to unlink this notebook from gallery?",label:"Yes",value:!0}).then(e=>{if(e.value){let e=this.currentNotebook();this.setGalleryMetadata(e,{}),this.triggerSave()}})}currentNotebook(){return this.notebooks.currentWidget.content}hasCurrentNotebook(){return this.notebooks.currentWidget===this.app.shell.currentWidget&&null!=this.notebooks.currentWidget.content&&null!=this.notebooks.currentWidget.content.model&&null!=this.notebooks.currentWidget.content.model.cells}hasLinkedNotebook(){if(this.hasCurrentNotebook()){let e=this.getGalleryMetadata(this.currentNotebook());return!!e&&null!=e.link}return!1}hasClonedNotebook(){if(this.hasCurrentNotebook()){let e=this.getGalleryMetadata(this.currentNotebook());return!!e&&null!=e.clone}return!1}hasUUID(){if(this.hasCurrentNotebook()){let e=this.getGalleryMetadata(this.currentNotebook());return!(!e||!e.uuid||null==!e.clone&&null==e.link&&null==e.uuid)}return!1}getGalleryLink(){if(this.hasCurrentNotebook()){let e=this.getGalleryMetadata(this.currentNotebook());return e&&e.gallery_url&&e.uuid?new URL(e.gallery_url):(e&&e.uuid,new URL(this.gallery_url))}return new URL(this.gallery_url)}getNotebookLink(){if(this.hasCurrentNotebook()){let e=this.getGalleryMetadata(this.currentNotebook());return e&&e.gallery_url&&e.uuid?new URL(r.URLExt.join(e.gallery_url,"nb",e.uuid)):e&&e.uuid?new URL(r.URLExt.join(this.gallery_url,"nb",e.uuid)):new URL(this.gallery_url)}return new URL(this.gallery_url)}buildMenus(){const{commands:e}=this.app;var t;e.addCommand("gallery-visit",{label:"Open in the Gallery",isEnabled:()=>this.hasUUID(),isVisible:()=>this.hasUUID(),execute:()=>{window.open(this.getNotebookLink().toString())}}),e.addCommand("gallery-upload",{label:"Upload to the Gallery",isEnabled:()=>""!=this.gallery_url&&!this.hasUUID()&&this.hasCurrentNotebook(),isVisible:()=>""!=this.gallery_url&&!this.hasUUID()&&this.hasCurrentNotebook(),execute:()=>{this.uploadCallback()}}),e.addCommand("gallery-save",{label:"Save Changes to Gallery",isEnabled:()=>this.hasLinkedNotebook(),isVisible:()=>this.hasLinkedNotebook(),execute:()=>{this.saveCallback()}}),e.addCommand("gallery-fork",{label:"Upload as a New Notebook (Fork)",isEnabled:()=>this.hasUUID(),isVisible:()=>this.hasUUID(),execute:()=>{let e=this.currentNotebook(),t=this.getGalleryMetadata(e).uuid;this.setGalleryMetadata(e,{parent_uuid:t}),this.uploadCallback()}}),e.addCommand("gallery-changereq",{label:"Submit Change Request",isEnabled:()=>this.hasUUID(),isVisible:()=>this.hasUUID(),execute:()=>{this.changereqCallback()}}),e.addCommand("gallery-checkupdates",{label:"Check for Changes",isEnabled:()=>this.hasUUID(),isVisible:()=>this.hasUUID(),execute:()=>{this.changesCallback()}}),e.addCommand("gallery-showdiff",{label:"Show Diff with Gallery",isEnabled:()=>this.hasUUID(),isVisible:()=>this.hasUUID(),execute:()=>{this.diffCallback()}}),e.addCommand("gallery-unlink",{label:"Unlink from Gallery",isEnabled:()=>this.hasUUID(),isVisible:()=>this.hasUUID(),execute:()=>{this.unlinkCallback()}}),e.addCommand("gallery-link",{label:"Link to Notebook in Gallery",isEnabled:()=>!this.hasUUID()&&this.hasCurrentNotebook(),isVisible:()=>!this.hasUUID()&&this.hasCurrentNotebook(),execute:()=>{this.linkCallback()}}),t=null;var a=this.mainMenu.menus;for(let e=0;e<a.length;e++)"jupyterlab_nbgallery-gallery"==a[e].id&&(t=a[e]);return null==t&&((t=new o.Menu({commands:e})).title.label="Gallery",t.id="jupyterlab_nbgallery-gallery"),t.addItem({command:"gallery-upload"}),t.addItem({command:"gallery-save"}),t.addItem({command:"gallery-changereq"}),t.addItem({command:"gallery-fork"}),t.addItem({command:"gallery-link"}),t.addItem({command:"gallery-unlink"}),t.addItem({command:"gallery-checkupdates"}),t.addItem({command:"gallery-showdiff"}),t.addItem({type:"separator"}),t.addItem({command:"gallery-visit"}),t}}const k=b}}]);