name: Documentation

on:
  push:
    branches: [ master ]
    paths:
      - 'docs/**'
      - 'pyproject.toml'
      - 'README.md'
  pull_request:
    branches: [ master ]
    paths:
      - 'docs/**'
      - 'pyproject.toml'
      - 'README.md'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force a documentation build'
        required: false
        default: false
        type: boolean

# Schedule a monthly build of the documentation
  schedule:
    - cron: '0 0 1 * *'

jobs:
  docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache-dependency-path: |
          pyproject.toml
          requirements*.txt

    - name: Cache UV installation
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('~/.cargo/bin/uv') }}

    - name: Install UV
      run: |
        if [ ! -f ~/.cargo/bin/uv ]; then
          curl -LsSf https://astral.sh/uv/install.sh | sh
        fi
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Cache Python virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: .venv
        key: ${{ runner.os }}-venv-docs-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-venv-docs-

    - name: Create and Activate Virtual Environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        uv venv .venv

    - name: Activate Virtual Environment
      run: |
        echo "VIRTUAL_ENV=.venv" >> $GITHUB_ENV
        echo "$PWD/.venv/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        uv pip install -e ".[docs]"

    - name: Build documentation
      run: |
        if [ ! -f "docs/conf.py" ]; then
          echo "Warning: docs/conf.py not found. Please create proper Sphinx documentation files."
          echo "Documentation build will be skipped. This is not considered a workflow failure."
          exit 0
        fi

        cd docs
        sphinx-build -b html -v . _build/html
        touch _build/html/.nojekyll

    - name: Archive documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/_build/html

    - name: Deploy to GitHub Pages
      if: github.event_name != 'pull_request' && github.ref == 'refs/heads/master'
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: docs/_build/html
        branch: gh-pages
        clean: true
        single-commit: false
