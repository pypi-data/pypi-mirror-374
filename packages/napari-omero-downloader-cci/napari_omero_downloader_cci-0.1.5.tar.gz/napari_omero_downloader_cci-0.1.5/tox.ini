# For more information about tox, see https://tox.readthedocs.io/en/latest/
[tox]
envlist = py{39}-{linux,macos,windows}
isolated_build=true
requires =
    tox<4
    tox-conda>=0.10,<0.11
    tox-gh-actions<3

[gh-actions]
python =
	3.9: py39

[gh-actions:env]
PLATFORM =
    ubuntu-latest: linux
    windows-latest: windows

[testenv]
basepython = python3.9
skip_missing_interpreters = true
conda_channels = conda-forge
conda_deps =
    napari
    omero-py
    pyqt

deps =
    pytest
    pytest-cov
	pytest-qt
    npe2
    magicgui
platform =
    macos: darwin
    linux: linux
    windows: win32

dependency_groups =
    testing
commands = python -X faulthandler tools/run_pytest.py

# ---- macOS overrides ----
[testenv:py39-macos]
conda_deps =
    napari
    omero-py
    pyqt
    pyopengl
    pyopengl-accelerate
setenv =
    NAPARI_TESTING = 1
    PYTEST_QT_API = pyqt5
    QT_API = pyqt5
    QT_QPA_PLATFORM = offscreen
    QT_OPENGL = software
    QT_MAC_WANTS_LAYER = 1
    OBJC_DISABLE_INITIALIZE_FORK_SAFETY = YES
    VISPY_USE_APP = PyQt5

# ---- Window overrides ----
[testenv:py39-windows]
setenv =
    NAPARI_TESTING = 1
    PYTEST_QT_API = pyqt5
    QT_API = pyqt5
    QT_QPA_PLATFORM = minimal
    QT_OPENGL = software

# ---- Linux overrides ----
[testenv:py39-linux]
setenv =
    NAPARI_TESTING = 1
    PYTEST_QT_API = pyqt5
    QT_API = pyqt5
    QT_QPA_PLATFORM = offscreen
    QT_OPENGL = software
    LIBGL_ALWAYS_SOFTWARE = 1
