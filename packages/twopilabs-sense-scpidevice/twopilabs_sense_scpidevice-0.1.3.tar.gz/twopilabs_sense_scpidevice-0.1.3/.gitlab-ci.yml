variables:
  GIT_SUBMODULE_STRATEGY: recursive # Update submodules
  GIT_STRATEGY: clone # Clone entire repo
  GIT_DEPTH: 0 # No shallow copy to get version info (tags/branches)

image: $PYTHON_BUILDUTILS_IMAGE

stages:
  - build
  - deploy

package:
  stage: build
  rules:
    - if: $PYTHON_BUILDUTILS_IMAGE
  script:
    - python3 -m build
  artifacts:
    paths:
      - dist/

# docs:
#   stage: build
#   script:
#     - pip install -r docs/requirements.txt
#     - pip install .
#     - sphinx-build -b html docs/ build/docs/
#   artifacts:
#     paths:
#       - build/

upload:
  stage: deploy
  dependencies:
    - package
  rules:
    - if: '$CI_COMMIT_TAG =~ /^([0-9]+)\.([0-9]+)\.([0-9]+)$/ && $PYPI_USERNAME && $PYPI_PASSWORD && $PYTHON_BUILDUTILS_IMAGE'
  script:
    - python3 -m twine upload -u $PYPI_USERNAME -p $PYPI_PASSWORD dist/*

# pages:
#   stage: deploy
#   dependencies:
#     - docs
#   rules:
#     - if: '$CI_COMMIT_TAG =~ /^([0-9]+)\.([0-9]+)\.([0-9]+)$/'
#   script:
#     - mv build/docs/ public/
#   artifacts:
#     paths:
#     - public

