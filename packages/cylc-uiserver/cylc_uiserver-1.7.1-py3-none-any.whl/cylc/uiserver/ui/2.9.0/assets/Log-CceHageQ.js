import{_ as R,bn as z,R as V,bo as J,bp as _,bq as Q,ao as G,x as I,z as h,e as c,y as C,F as Y,r as H,aA as X,B as S,br as Z,ar as K,aq as N,o as u,t as b,bs as $,bt as ee,bu as te,bv as oe,bw as le,a7 as se,w as s,j as q,bx as ie,by as ae,ae as re,bz as ne,bA as ue,bB as de,af as F,bC as ce,bD as fe,q as j,bE as pe,ak as g,I as B,J as he,bF as me,C as D,g as l,V as T,h as L,X as ge,l as x,bG as O,A as be,bH as P,D as we,E as ye,bI as ve,ag as ke}from"./index-DDu-sG2I.js";import{V as Le,b as xe}from"./ViewToolbar-BGs5uHwk.js";import{g as Se}from"./graphql-By5b_CWU.js";import{i as Ve,u as Ie,a as v}from"./initialOptions-CXHi_3QY.js";import{d as Fe}from"./debounce-kA5Pjyac.js";import{V as De}from"./VAlert-BPEcBbTz.js";const Te={name:"LogComponent",props:{placeholder:{type:String,required:!1},timestamps:{type:Boolean,required:!1,default:!0},logs:{type:Array,required:!0},wordWrap:{type:Boolean,required:!1,default:!1},autoScroll:{type:Boolean,required:!1,default:!1}},emits:["update:autoScroll"],setup(t,{emit:e}){const i=V("logText"),o=V("scrollWrapper"),w=V("autoScrollEnd"),a=Z(t,"autoScroll",e),{arrivedState:d,directions:f}=J(o);_(()=>d.bottom&&!d.top,()=>{a.value=!0}),_(()=>t.logs.length&&f.top,()=>{a.value=!1});function p(){w.value?.scrollIntoView({behavior:"smooth"})}async function r(){a.value=!1,await K(),o.value?.scroll({top:0,left:0,behavior:"smooth"})}const m=new ResizeObserver(p);return Q(i,()=>{N(a,k=>{k?(p(),m.observe(i.value)):(o.value.scrollBy(0,0),m.disconnect())},{immediate:!0})}),G(()=>{m.disconnect()}),{scrollToTop:r}},computed:{computedLogs(){return this.logs.length>0?this.timestamps?this.logs:this.updateLogs():this.placeholder?[this.placeholder]:[]}},methods:{updateLogs(){return this.logs.map(t=>this.stripTimestamp(t))},stripTimestamp(t){const e=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-][\d:]+)?\s(.*\s*)/;return t.match(e)?.[1]??t}},icons:{mdiMouseMoveUp:z}},_e={ref:"scrollWrapper",class:"h-100 overflow-auto px-4 pb-2"},Ce={ref:"autoScrollEnd"};function Be(t,e,i,o,w,a){return u(),I("div",_e,[h("pre",{ref:"logText",class:X(i.wordWrap?"text-pre-wrap text-break":"text-pre"),"data-cy":"log-text"},[(u(!0),I(Y,null,H(a.computedLogs,(d,f)=>(u(),I("span",{key:f},b(d),1))),128))],2),i.logs.length?(u(),c(S,{key:0,position:"fixed",location:"bottom right",class:"ma-5",onClick:o.scrollToTop,icon:t.$options.icons.mdiMouseMoveUp,"data-cy":"log-scroll-top"},null,8,["onClick","icon"])):C("",!0),h("div",Ce,null,512)],512)}const We=R(Te,[["render",Be]]),qe=B`
subscription LogData ($id: ID!, $file: String!) {
  logs (id: $id, file: $file) {
    lines
    connected
    path
    error
  }
}
`,je=B`
query LogFiles($id: ID!) {
  logFiles(id: $id) {
    files
  }
}
`,Oe=B`
query JobState($id: ID!, $workflowId: ID!) {
  jobs (live: false, ids: [$id], workflows: [$workflowId]) {
    id
    state
  }
}
`;class E{constructor(){this.lines=[],this.host=null,this.path=null,this.connected=null,this.error=null}}class Pe extends he{constructor(e){super(),this.results=e}onAdded(e,i,o){this.results.connected===!1&&(this.results.lines=[]),e.lines&&this.results.lines.push(...e.lines),e.connected!=null&&(this.results.connected=e.connected),e.error!=null&&(this.results.error=e.error),e.path!=null&&([this.results.host,this.results.path]=e.path.split(":",2))}}const Ee={name:"Log",mixins:[Se,se],components:{CopyBtn:le,LogComponent:We,ViewToolbar:Le},emits:[Ie],props:{initialOptions:Ve},setup(t,{emit:e}){const i=me(),o=v("relativeID",{props:t,emit:e}),w=ce(o),a=fe(o.value,{onChanged:Fe(n=>{o.value=n},500)});function d(n){return!n||(F.validate(n,!0)??!0)}const f=j(()=>{if(o.value)try{const n=new F(o.value,!0);if(n.task)return n.job?n:n.clone({job:"NN"})}catch{}return null}),p=v("file",{props:t,emit:e}),r=v("timestamps",{props:t,emit:e},!0),m=pe(),k=v("wordWrap",{props:t,emit:e},m.value);N(k,n=>{m.value=n});const y=g(new E);function U(){y.value=new E}const A=j(()=>y.value.path?.substring(0,y.value.path.length-p.value.length-1));_(()=>i.state.offline,()=>{y.value.connected=!1});const M=v("autoScroll",{props:t,emit:e},!0),W="40";return{query:g(null),logFiles:g([]),results:y,parentPath:A,relativeID:o,previousRelativeID:w,inputID:a,validateInputID:d,relativeTokens:f,file:p,fileLabel:g("Select File"),fileDisabled:g(!1),jobLog:g(o.value==null?0:1),timestamps:r,wordWrap:k,autoScroll:M,reset:U,toolbarBtnSize:W,toolbarBtnProps:xe(W)}},mounted(){this.$watch(()=>({id:this.id??void 0,file:this.file??void 0}),async({id:t},e)=>{this.updateQuery(),t!==e?.id&&await this.setNewFile(!e)},{immediate:!0})},computed:{workflowTokens(){return new F(this.workflowId)},id(){return this.jobLog?this.relativeTokens?.clone(this.workflowTokens)?.id:this.workflowId},controlGroups(){return[{title:"Log",controls:[{title:"Timestamps",icon:ne,action:"toggle",value:this.timestamps,key:"timestamps"},{title:"Word wrap",icon:ue,action:"toggle",value:this.wordWrap,key:"wordWrap"},{title:"Auto scroll",icon:de,action:"toggle",value:this.autoScroll,key:"autoScroll"}]}]}},methods:{setOption(t,e){this[t]=e},updateQuery(){if(this.reset(),!this.file||!this.id){this.query=null;return}this.query=new re(qe,{id:this.id,file:this.file},`log-query-${this._uid}`,[new Pe(this.results)],!1,!1)},async getDefaultJobLog(){let t;try{this.relativeTokens&&(t=await this.$workflowService.query2(Oe,{id:this.relativeTokens.id,workflowId:this.workflowTokens.workflow}))}catch(e){console.error(e);return}return ae(t?.data?.jobs?.[0]?.state)},getDefaultWorkflowLog(){return this.logFiles.find(t=>t.startsWith("scheduler/"))},async updateLogFileList(){if(!this.id){this.handleNoLogFiles();return}this.fileLabel="Updating available files...",this.fileDisabled=!0;let t;try{t=await this.$workflowService.apolloClient.query({query:je,variables:{id:this.id}})}catch(i){this.handleLogFileListingErr(i),this.handleNoLogFiles();return}if(!this.id)return;const e=t.data.logFiles?.files??[];e.length?(this.fileLabel="Select File",this.fileDisabled=!1,this.logFiles=e):(t.errors?.length&&this.handleLogFileListingErr(t.errors[0].message),this.handleNoLogFiles())},async setNewFile(t){const e=[this.updateLogFileList()];this.jobLog&&!t&&e.push(this.getDefaultJobLog().then(i=>{this.file=i})),await Promise.all(e),this.jobLog||(this.file=this.getDefaultWorkflowLog())},handleNoLogFiles(){this.fileLabel=this.id?`No log files for ${this.id}`:"Enter a task/job ID",this.fileDisabled=!0,this.logFiles=[]},handleLogFileListingErr(t){this.$store.dispatch("setAlert",new ie(t,"error"))}},watch:{jobLog(t,e){this.file=null,this.relativeID=t?this.previousRelativeID:null}},icons:{mdiFolderRefresh:oe,mdiPowerPlug:te,mdiPowerPlugOff:ee,mdiFileAlertOutline:$}},Re={"data-cy":"log-path",class:"ml-2 mr-1 d-flex text-medium-emphasis text-pre overflow-x-hidden"},Ne={class:"flex-shrink-1 text-truncate"},Ue={class:"text-pre-wrap text-break"};function Ae(t,e,i,o,w,a){const d=D("ViewToolbar"),f=D("CopyBtn"),p=D("log-component");return u(),c(q,{class:"c-log h-100 pa-0 d-flex flex-column",fluid:""},{default:s(()=>[l(q,{fluid:""},{default:s(()=>[l(T,{dense:"",class:"flex-0-0"},{default:s(()=>[l(L,{class:"pt-0"},{default:s(()=>[l(ge,{modelValue:o.jobLog,"onUpdate:modelValue":e[0]||(e[0]=r=>o.jobLog=r),divided:"",mandatory:"",variant:"outlined",color:"primary",density:"comfortable"},{default:s(()=>[l(S,{"data-cy":"workflow-toggle"},{default:s(()=>[...e[6]||(e[6]=[x("Workflow",-1)])]),_:1}),l(S,{"data-cy":"job-toggle"},{default:s(()=>[...e[7]||(e[7]=[x("Job",-1)])]),_:1})]),_:1},8,["modelValue"]),l(d,{groups:a.controlGroups,onSetOption:a.setOption,size:o.toolbarBtnSize},null,8,["groups","onSetOption","size"])]),_:1})]),_:1}),l(T,{dense:"",class:"flex-0-0"},{default:s(()=>[l(L,{cols:"8"},{default:s(()=>[o.jobLog?(u(),c(O,{key:0,"data-cy":"job-id-input",class:"flex-grow-1 flex-column",modelValue:o.inputID,"onUpdate:modelValue":e[1]||(e[1]=r=>o.inputID=r),rules:[o.validateInputID],placeholder:"cycle/task/job",clearable:""},null,8,["modelValue","rules"])):(u(),c(O,{key:1,"data-cy":"workflow-id-input",modelValue:t.workflowId,"onUpdate:modelValue":e[2]||(e[2]=r=>t.workflowId=r),disabled:""},null,8,["modelValue"]))]),_:1}),l(L,{cols:"4",class:"d-flex align-start col-gap-2"},{default:s(()=>[l(be,{"data-cy":"file-input",label:o.fileLabel,disabled:o.fileDisabled,items:o.logFiles,modelValue:o.file,"onUpdate:modelValue":e[3]||(e[3]=r=>o.file=r),"menu-props":{"data-cy":"file-input-menu"}},null,8,["label","disabled","items","modelValue"]),l(S,P({onClick:e[4]||(e[4]=()=>this.updateLogFileList())},o.toolbarBtnProps,{"data-cy":"refresh-files"}),{default:s(()=>[l(we,{icon:t.$options.icons.mdiFolderRefresh},null,8,["icon"]),l(ye,null,{default:s(()=>[...e[8]||(e[8]=[x("Refresh file list",-1)])]),_:1})]),_:1},16)]),_:1})]),_:1}),l(T,{dense:"",class:"flex-0-0"},{default:s(()=>[o.results.path?(u(),c(L,{key:0,class:"d-flex align-center"},{default:s(()=>[l(ve,P({"data-cy":"connected-icon",variant:"outlined",class:"flex-shrink-0"},o.results.connected?{color:"success",prependIcon:t.$options.icons.mdiPowerPlug}:{color:"error",prependIcon:t.$options.icons.mdiPowerPlugOff,onClick:a.updateQuery}),{default:s(()=>[x(b(o.results.connected?"Connected":"Reconnect"),1)]),_:1},16),h("div",Re,[h("span",null,b(o.results.host)+":",1),h("span",Ne,b(o.parentPath),1),h("span",null,"/"+b(o.file),1)]),l(f,{text:o.results.path,tooltip:"Copy path"},null,8,["text"])]),_:1})):C("",!0)]),_:1}),o.results.error?(u(),c(De,{key:0,type:"error",variant:"tonal",density:"compact",class:"mt-2",icon:t.$options.icons.mdiFileAlertOutline},{default:s(()=>[h("span",Ue,b(o.results.error),1)]),_:1},8,["icon"])):C("",!0)]),_:1}),a.id&&o.file&&o.results.connected==null?(u(),c(ke,{key:0,type:"text@5",class:"align-content-start"})):(u(),c(p,{key:1,"data-cy":"log-viewer",logs:o.results.lines,timestamps:o.timestamps,"word-wrap":o.wordWrap,autoScroll:o.autoScroll,"onUpdate:autoScroll":e[5]||(e[5]=r=>o.autoScroll=r)},null,8,["logs","timestamps","word-wrap","autoScroll"]))]),_:1})}const He=R(Ee,[["render",Ae]]);export{He as default};
