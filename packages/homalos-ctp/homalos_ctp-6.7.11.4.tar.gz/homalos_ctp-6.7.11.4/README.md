<p align="center">
  English |
  <a href="https://github.com/Homalos/ctp/blob/main/README_CN.md">ÁÆÄ‰Ωì‰∏≠Êñá</a>
</p>

# Project Description

This project automatically generates Python APIs based on the CTP C++ API, making it easier for CTP Python developers to maintain the latest CTP interfaces and quickly upgrade CTP versions.

Note: This project has only been tested under CTP v6.7.11. Other versions have not been tested. The project CTP version number is configured in the `ctp/__init__.py` file.

## 1. Compilation Environment

This project is compiled using the following environment. If you use other tool versions, please make appropriate adjustments.

- **Windows 11 + MSVC 2022**

- **Python 3.13.6** virtual environment, installed by UV.

- **CTP v6.7.11**: [CTP official download link](https://www.simnow.com.cn/static/apiDownload.action)

- **Meson + Ninja**: A modern C++ extension build system.

- **Pybind11**: Python C++ bindings

- **UV**: A modern Python package manager with faster installation and smarter dependency resolution.

## 2. Project Structure

```reStructuredText
ctp/
‚îú‚îÄ‚îÄ üìÇ ctp/		# CTP interface module
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ api/		# CTP API module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÇ generator/		# C++ and Python binding generation script
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÇ include/		# CTP API header files
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÇ libs/		# CTP API static library files
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÇ src/		# CTP and Python binding code files
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ __init__.py		# MdApi and TdApi initialization imports
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ ctp_constant.py 		# CTP API Constants
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ ctpmd.cp313-win_amd64.pyd		# Market extension module compiled from C++ to Python
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ ctpmd.pyi		# Stub file for the market extension module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ ctptd.cp313-win_amd64.pyd		# Trading extension module compiled from C++ to Python
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ ctptd.pyi		# Stub file for the trading extension module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ custom_constant.py 			# User-defined constant class
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ thostmduserapi_se.dll		# Windows CTP market API dynamic link library
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ thostmduserapi_se.so		# Linux CTP market API dynamic link library
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ thosttraderapi_se.dll		# Windows CTP trading API dynamic link library
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ thosttraderapi_se.so		# Linux CTP trading API dynamic link library
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ __init__.py		# CTP version configuration file
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ __version__.py		# Project version configuration file
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ ctp.h		# Task processing and encoding conversion
‚îú‚îÄ‚îÄ üìÇ docs/		# Project documentation
‚îú‚îÄ‚îÄ üìÅ .gitignore		# Git commit ignore files, automatically generated by UV
‚îú‚îÄ‚îÄ üìÅ .python-version	# Project Python version file, automatically generated by UV
‚îú‚îÄ‚îÄ üìÅ LICENSE		# Project license file
‚îú‚îÄ‚îÄ üìÅ README.md		# Project description file in Chinese
‚îú‚îÄ‚îÄ üìÅ README_CN.md		# Project description file in English
‚îú‚îÄ‚îÄ üìÅ build.py		# Extension module automated compilation script, assembling Meson commands
‚îú‚îÄ‚îÄ üìÅ hatch_build.py		# Hatch hook, set the platform identifier when packaging with hatch
‚îú‚îÄ‚îÄ üìÅ md_demo.py		# Example of using the market extension module
‚îú‚îÄ‚îÄ üìÅ meson.build		# Meson build configuration file
‚îú‚îÄ‚îÄ üìÅ pyproject.toml		# Python project management configuration file, automatically generated by uv
‚îú‚îÄ‚îÄ üìÅ td_demo.py		# Example of using the transaction extension module
‚îú‚îÄ‚îÄ üìÅ util.py		# Public Tools
‚îî‚îÄ‚îÄ üìÅ uv.lock		# uv lock file, automatically generated by uv
```

## 3. Install the Basic Environment (skip if already installed)

1. Install UV

On Windows

**Method 1: Global Installation (Recommended, choose one)**

```bash
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
```

**Method 2: Install in a Single Python Environment (Choose one)**

```bash
pip install uv
```

On Linux

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

2. Install Python (Perform this step with Method 1, skip this with Method 2). I use 3.13.6; you can install your preferred version.

```bash
uv python install 3.13
```

## 4. Usage

Download the Release source code of this project or install it using the command:

```bash
pip install homalos-ctp
```

1. Install a Python virtual environment and dependencies (execute from the root directory)

```bash
# Use uv to create a Python virtual environment with a specified version in the current project.

uv venv --python 3.13 .venv

```

```bash
# Install dependent libraries

uv add meson-python

uv add pybind11

uv add pybind11-stubgen

```

2. Execute the one-click build script in the `generator` directory (to generate Python bindings for the CTP C++ API)

```bash
# Activate the Python virtual environment and enter the generator.

.venv\Scripts\activate

cd homalos-ctp\api\generator
```

```bash
# Generate binding files with one click.

python generate_onekey.py
```

3. Execute the following build script in the root directory to generate the CTP C++ API and encapsulate it into a Python-callable interface.

```bash
# Compile the CTP Python API with one click.

python build.py
```

## 5. Demo Test

1. **Testing the Market Extension Module**

In the project root directory, fill in the CTP environment information in `md_demo.py` and run it. The results are as follows:

```reStructuredText
Start connecting to CTP market server...
CtpMdApiÔºöTrying to create an API with path D:\Project\PycharmProjects\homalos-ctp\con/md
CtpMdApiÔºöcreateFtdcMdApi call succeeded.
CtpMdApiÔºöTry initializing the API using the address:tcp://182.254.243.31:40011...
CtpMdApiÔºöinit call succeeded.
Connecting to tcp://182.254.243.31:40011...
Waiting for connection and login to complete...
ctp md api callback: onFrontConnected - The market data server is connected successfully
Start the login process
CtpMdApiÔºöreqUserLogin call succeeded.
ctp md api callback: onRspUserLogin - The market server login is successful
Starting to subscribe to 2 contracts...
Subscription contract: SA601
Prepare subscription contract: SA601
Send subscription request SA601
Subscription request sent SA601
ctp md api callback: onRspSubMarketData - Subscription feedback, Contract=SA601, ErrorID=0
symbol: SA601
ctp md api callback: onRtnDepthMarketData
CTP Market data reception: SA601 @ 17:00:34 LastPrice=1276.0
Subscription contract: FG601
Prepare subscription contract: FG601
Send subscription request FG601
Subscription request sent FG601
ctp md api callback: onRtnDepthMarketData
CTP Market data reception: SA601 @ 17:00:35 LastPrice=1276.0
...
```

2. **Testing the transaction extension module**

Fill in the CTP environment information in `td_demo.py` in the project root directory and run it. The result is as follows:

```reStructuredText
CtpTdApi: Attempting to create an API with path D:\Project\PycharmProjects\homalos-ctp\con/td
CtpTdApi: createFtdcTraderApi call succeeded.
CtpTdApiÔºöÂ∞ùËØï‰ΩøÁî®Âú∞ÂùÄÂàùÂßãÂåñ APIÔºötcp://182.254.243.31:30001...
CtpTdApiÔºöinit Ë∞ÉÁî®ÊàêÂäü„ÄÇ
Waiting for connection and login to complete...
ctp td api callback: onFrontConnected - Trading server connection successful
ÂºÄÂßãËÆ§ËØÅÔºåauth_status: False
ÂèëÈÄÅËÆ§ËØÅËØ∑Ê±ÇÔºåreq_id: 1
Transaction server authorization verification successful
ÂºÄÂßãÁôªÂΩïÔºålogin_status: False
ÂèëÈÄÅÁôªÂΩïËØ∑Ê±ÇÔºåreq_id: 2
ctp td api callback: onRspUserLogin - Login Response, ErrorID=0
Trading server login successful
Settlement information confirmed successfully

üöÄ ÂºÄÂßã‰∏ãÂçïÊµãËØï...
Ê≠£Âú®ÂßîÊâò‰∏ãÂçï...
symbol: SA601
direction: BUY_OPEN
price: 1286
volume: 1
ÂßîÊâòËØ∑Ê±ÇÂèëÈÄÅÊàêÂäü
ÂßîÊâò‰∏ãÂçïÊàêÂäüÔºåÂßîÊâòÂè∑Ôºö1_-394894342_1
‰∏ãÂçïÂÆåÊàêÔºåËÆ¢ÂçïÂè∑: 1_-394894342_1

‚è∞ Á≠âÂæÖ5ÁßíËßÇÂØüËÆ¢ÂçïÁä∂ÊÄÅ...
ctp td api callback: onRtnOrder
ËÆ¢ÂçïÁä∂ÊÄÅÊõ¥Êñ∞ - ËÆ¢Âçï IDÔºö1_-394894342_1ÔºåÁä∂ÊÄÅÔºöÊú™Áü• (a)
Áä∂ÊÄÅÂèòÂåñ: Êñ∞ËÆ¢Âçï -> Êú™Áü•
ctp td api callback: onRtnOrder
ËÆ¢ÂçïÁä∂ÊÄÅÊõ¥Êñ∞ - ËÆ¢Âçï IDÔºö1_-394894342_1ÔºåÁä∂ÊÄÅÔºöÊú™Áü• (a)
Áä∂ÊÄÅÂèòÂåñ: a -> Êú™Áü•
ctp td api callback: onRtnOrder
ËÆ¢ÂçïÁä∂ÊÄÅÊõ¥Êñ∞ - ËÆ¢Âçï IDÔºö1_-394894342_1ÔºåÁä∂ÊÄÅÔºöÂÖ®ÈÉ®Êàê‰∫§ (0)
ËÆ¢ÂçïÂÖ®ÈÉ®Êàê‰∫§ - ËÆ¢ÂçïÂè∑: 1_-394894342_1, ÂêàÁ∫¶: SA601
Áä∂ÊÄÅÂèòÂåñ: a -> ÂÖ®ÈÉ®Êàê‰∫§
ctp td api callback: onRtnTrade
onRtnTrade trade_id: 2025090800029227, order_id:        48977, price: 1286.0, volume: 1, trade_date: 20250905, trade_time: 21:41:12

==================================================
üìã ËÆ¢ÂçïÁä∂ÊÄÅÊ±áÊÄª
==================================================
ËÆ¢ÂçïÂè∑: 1_-394894342_1 | Áä∂ÊÄÅ: ÂÖ®ÈÉ®Êàê‰∫§
==================================================
...
```

## 6. Script Function Details

The generator script is located in `ctp/api/generator/`

1. `generator_function_const.py`

- **Purpose**: **Generates basic function constant files**
- **Function**:
- Reads the CTP header files `ThostFtdcMdApi.h` and `ThostFtdcTraderApi.h.h`
- Parses the functions therein and generates `ctp_function_const.py` (function constant definitions)

2. `generate_data_type.py`

- **Purpose**: **Generates data type definition files**
- **Function**:
- Reads the CTP header file `ThostFtdcUserApiDataType.h`
- Parses the `#define` constant definitions and `typedef` type definitions therein
- Generates `ctp_function_const.py`

3. `generate_struct.py`

- **Purpose**: **Generates structure definition files**
- **Function**:
- Reads the CTP header file `ThostFtdcUserApiStruct.h`
- Relies on the type mappings in `ctp_typedef.py`
- Parses the C++ structure definition and generates the Python dictionary-formatted structure definition file `ctp_struct.py`

4. `generate_api_functions.py`

- **Purpose**: **Generates API function binding code**
- **Function**:
- Reads the CTP API header files (such as `ThostFtdcTraderApi.h` and `ThostFtdcMdApi.h`)
- Relies on the structure definitions in `ctp_struct.py`
- Generates a large number of C++ source code files for Python bindings

5. `generate_dll_entry.py`

- **Purpose**: **Generates the C++ DLL entry point code file**
- **Function**:
- Generates three files: `dllmain.cpp`, `stdafx.cpp`, and `stdafx.h`.

- **dllmain.cpp**: Contains the standard DLL entry point function, handling process and thread loading/unloading.
- **stdafx.cpp**: A simple precompiled header include file.
- **stdafx.h**: Contains the Windows API header files and common definitions.

6. `generate_cpp.py`

- **Purpose**: **Generates `cpp` and `h` files**
- **Function**: **Generates `ctpmd.cpp`, `ctpmd.h`, and `ctptd.cpp`, `ctptd.h`, for `ctp.api.src.ctpmd` and `ctp.api.src.ctptd`, respectively.
- The header file contains complete class declarations and function prototypes.
- The `cpp` file contains all implementation and bindings.

7. `generate_onekey.py`

- **Purpose**: **One-click assembles all md and td header, source, and other files to generate cpp and h files**
- **Function**:
- One-click assembles the files generated by the above files, as well as header, source, and other files, to generate four files: `ctpmd.cpp`, `ctpmd.h`, and `ctptd.cpp`, `ctptd.h`.

8. `build.py`

- **Purpose**: **One-click compiles the CTP C++ API into a Python API**
- **Function**:
- One-click compiles the Python-callable CTP API files, located in `ctp/api/`. These files include:
- `ctpmd.cp313-win_amd64.pyd`
- `ctptd.cp313-win_amd64.pyd`
- `ctpmd.pyi`
- `ctptd.pyi`

File Dependencies:

1. **`generator_function_const.py`** ‚Üí Generate `ctp_function_const.py`
2. **`generate_data_type.py`** ‚Üí Generate `ctp_typedef.py` and `ctp_constant.py`
3. **`generate_struct.py`** (depends on `ctp_typedef.py`) ‚Üí Generate `ctp_struct.py`
4. **`generate_api_functions.py`** (depends on `ctp_struct.py` and `ctp_function_const.py`) ‚Üí Generate multiple API header and source binding files for `md` and `td`
5. **`generate_dll_entry.py`** ‚Üí Generate `dllmain.cpp`, `stdafx.cpp`, and `stdafx.h`
6. **`generate_cpp.py`** (depends on all the above files, as well as the generated header and source files) ‚Üí Generates `ctpmd.cpp`, `ctpmd.h`, and `ctptd.cpp` and `ctptd.h`
7. **`generate_onekey.py`** ‚Üí Assembles `ctpmd.cpp`, `ctpmd.h`, and `ctptd.cpp` and `ctptd.h` files with one click (equivalent to executing the above process with one click)
8. **`build.py`** (depends on the `ctpmd` and `ctptd` modules in `ctp/api/src/`) ‚Üí Compiles `ctpmd.cp313-win_amd64.pyd`, `ctptd.cp313-win_amd64.pyd`, `ctpmd.pyi`, and `ctptd.pyi` with one click

## 7. Script Usage

The code generated by these scripts is used to:

- Encapsulate the CTP C++ API into a Python-callable interface
- Automatically handle data type conversion
- Generate Python bindings for callback functions
- Generate Python bindings for request functions

## 8. Advantages

- Use pybind to bind C++ to the Python CTP API, offering superior performance compared to SWIG conversion.
- Automatic synchronization: When the CTP official header files are updated, the latest h, dll, so, and lib files are replaced. After executing the generated script, the script will automatically reflect the latest virtual functions.
- Easy maintenance: No need to manually update a large number of hard-coded function declarations.
- Reduced errors: Avoid omissions or errors that may result from manual maintenance.
- Improved efficiency: Developers only need to focus on business logic, without worrying about changes to the underlying interfaces.

Summary: This is a complete code generation toolchain that automatically generates Python bindings for the CTP API, eliminating the need to manually write repetitive binding code and improving maintainability and robustness.

## 9. Community Support

- **Technical Exchange (QQ Group)**: `446042777`
- [pypi.org](https://pypi.org/project/homalos-ctp)

## 10. Disclaimer

**[Disclaimer Content](docs/Disclaimer.md)**

## 11. Replenish

**Meson**: Similar to Make and CMake, its main task is to configure the compilation environment, generate compilation instructions (for example, for Ninja), and manage the entire compilation process. It does not directly compile code, but rather drives tools like Ninja to do so.

**Pybind11**: A lightweight C++ library for exposing (binding) C++ code to the Python interpreter. It allows Python code to seamlessly call C++ functions and classes, just like calling regular Python modules. Its core goal is to provide an extremely simple, nearly boilerplate-free interface that easily combines the high-performance computing capabilities of C++ with the ease of use and vast Python ecosystem.

---

*homalos-ctp*
*Last Updated: 2025-09-05*