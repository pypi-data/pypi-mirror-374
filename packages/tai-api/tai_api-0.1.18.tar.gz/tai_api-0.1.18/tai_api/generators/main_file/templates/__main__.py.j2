"""
{{ project_name }} - Main Application
Generado automáticamente por tai-api

Este es el archivo principal de la aplicación FastAPI.
Estado: Proyecto completo con autenticación y API de base de datos
"""

from pathlib import Path
from fastapi import FastAPI, Depends
from fastapi.staticfiles import StaticFiles
from starlette.middleware.cors import CORSMiddleware 
from {{ routers_import_path }} import generated_api_router
from {{ resources_import_path }} import setup_exception_handlers, set_mcp
from {{ auth_import_path }} import auth_router, get_current_user

cwd = Path(__file__).parent
description = """
<details>
<summary>Mostrar diagrama ER</summary>

![ER](/diagrams/public.png)

</details>
"""

app = FastAPI(
    title="{{ project_name }}",
    version="{{ version }}",
    description=description
)

# Montar carpeta estática de diagramas
app.mount("/diagrams", StaticFiles(directory=cwd / "diagrams"), name="diagrams")

# Incluir router de autenticación
app.include_router(auth_router)

# Incluir router de API generada
app.include_router(
    generated_api_router, 
    dependencies=[Depends(get_current_user)]
)

# Configurar manejadores de excepciones
setup_exception_handlers(app)

# Configurar CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Configurar según ambiente
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

{% if with_mcp %}
set_mcp(
    app,
    {% if operations %}
    operations=[
        {% for operation in operations %}
        "{{ operation }}"{% if not loop.last %},{% endif %}{{''}}
        {% endfor %}
    ]
    {% endif %}
)
{% endif %}