<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Bangumi Data 批量操作</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .head {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 10px;
        }
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .item-list {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }
        .item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .item.selected {
            border-color: #409eff;
            box-shadow: 0 2px 12px rgba(64,158,255,0.15);
        }
        .item img {
            width: 100px;
            height: 140px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .item-title {
            font-size: 15px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
            cursor: pointer;
        }
        .item-id {
            font-size: 12px;
            color: #888;
        }
        .selected-list {
            margin-top: 20px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .mask {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.7);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #409eff;
            font-weight: bold;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div class="head">
        <h1>让我们快乐地 Cheating</h1>
    </div>
    <div class="controls">
        <label for="default-type">操作类型：</label>
        <select id="default-type">
            <option value="1">想看</option>
            <option value="2" selected>看过</option>
            <option value="3">在看</option>
            <option value="4">搁置</option>
            <option value="5">抛弃</option>
        </select>
        年份：<input type="number" id="year" value="2025" min="1943" max="2100">
        月份：<input type="number" id="month" value="8" min="1" max="12">
        <button onclick="loadData()">加载数据</button>
        <button onclick="addMonthAndReload()">下个月</button>
    </div>
    <div class="controls" id="img-size-controls" style="display:none;">
        图片大小：<input type="range" id="img-size-slider" min="60" max="240" value="100" step="1" style="width:200px;vertical-align:middle;">
        <span id="img-size-label">100px</span>
    </div>
    <div id="item-list" class="item-list"></div>
    <div id="selected-list" class="selected-list" style="display:none;"></div>
    <div id="mask" class="mask" style="display:none;">正在处理，请稍候...</div>
    <script>
        let selectedIds = [];
        let itemMap = {};
        let imgSize = 100;
        let selectedTypes = {};
        function getName(item){
            if (item.titleTranslate && item.titleTranslate["zh-Hans"] && item.titleTranslate["zh-Hans"].length > 0) {
                return item.titleTranslate["zh-Hans"][0];
            }
            if (item.titleTranslate && item.titleTranslate["zh-Hant"] && item.titleTranslate["zh-Hant"].length > 0) {
                return item.titleTranslate["zh-Hant"][0];
            }
            return item.title;
        }
        function getBgmId(item){
            if (!item.sites){
                return null
            }
            for (const i of item['sites']) {
                if (i && i['site'] === 'bangumi') {
                    return i['id'];
                }
            }
            return '';
        }
        function toggleSelect(checkbox) {
            const id = parseInt(checkbox.value);
            if (checkbox.checked) {
                if (!selectedIds.includes(id)) selectedIds.push(id);
            } else {
                selectedIds = selectedIds.filter(i => i !== id);
            }
        }
        document.getElementById('default-type').addEventListener('change', function() {
            // 仅用于调试，打印当前类型
            console.log('批量收藏类型已切换为:', this.value);
        });
        function showMask() {
            document.getElementById('mask').style.display = '';
        }
        function hideMask() {
            document.getElementById('mask').style.display = 'none';
        }
        function submitBatch() {
            if (selectedIds.length === 0) {
                alert('请至少选择一个条目');
                return;
            }
            // 获取批量收藏类型（每次提交时都重新获取当前值）
            const type = document.getElementById('default-type').value;
            console.log('提交时 type =', type);
            showMask();
            fetch('/api/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: selectedIds, type })
            })
            .then(res => res.json())
            .then(data => {
                alert(`已处理 ${data.count} 个条目`);
                // 清空选中数据
                selectedIds = [];
                renderSelectedList();
                document.querySelectorAll('.item').forEach(card => card.classList.remove('selected'));
            })
            .finally(() => {
                hideMask();
            });
        }
        function renderSelectedList() {
            const selectedDiv = document.getElementById('selected-list');
            selectedDiv.style.display = '';
            if (selectedIds.length === 0) {
                selectedDiv.style.display = 'none';
                selectedDiv.innerHTML = '';
                return;
            }
            selectedDiv.style.display = '';
            selectedDiv.innerHTML = ' <button onclick="submitBatch()">批量提交</button> <b>已选中条目：</b>';
            selectedIds.forEach(id => {
                const item = itemMap[id];
                if (!item) return;
                const div = document.createElement('div');
                div.style.display = 'inline-block';
                div.style.margin = '4px';
                div.style.padding = '4px 8px';
                div.style.border = '1px solid #409eff';
                div.style.borderRadius = '6px';
                div.style.background = '#f0f7ff';
                div.style.cursor = 'pointer';
                div.innerHTML = `${getName(item)} <span style='color:#888;font-size:12px;'>(${id})</span> <span style='color:red;cursor:pointer;' title='移除'>&times;</span>`;
                div.querySelector('span[title]')?.addEventListener('click', function(e) {
                    console.log('移除选中:', id);
                    selectedIds = selectedIds.filter(i => i !== id);
                    document.querySelectorAll('.item').forEach(card => {
                        if (card.querySelector('.item-id')?.textContent === `ID: ${id}`) {
                            card.classList.remove('selected');
                        }
                    });
                    renderSelectedList();
                });
                selectedDiv.appendChild(div);
            });
        }
        document.getElementById('img-size-slider').addEventListener('input', function() {
            imgSize = parseInt(this.value);
            document.getElementById('img-size-label').textContent = imgSize + 'px';
            document.querySelectorAll('.item img').forEach(img => {
                img.style.width = imgSize + 'px';
                img.style.height = Math.round(imgSize * 1.4) + 'px';
            });
            // 动态调整 grid 容器宽度
            const grid = document.getElementById('item-list');
            grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${imgSize + 80}px, 1fr))`;
            console.log('图片大小调整:', imgSize, '容器列宽:', imgSize + 80);
        });
        function renderItem(item) {
            const div = document.createElement('div');
            div.className = 'item';
            const bgmId = getBgmId(item);
            let imgHtml = '';
            if (bgmId) {
                imgHtml = `<img src="https://api.bgm.tv/v0/subjects/${bgmId}/image?type=common" alt="cover" style="width:${imgSize}px;height:${Math.round(imgSize*1.4)}px;" onerror="this.style.display='none'">`;
            }
            let urlHtml = '';
            if (bgmId) {
                urlHtml = `<a href='https://bgm.tv/subject/${bgmId}' target='_blank' style='display:block;font-size:12px;color:#409eff;text-decoration:underline;margin-top:2px;'>https://bgm.tv/subject/${bgmId}</a>`;
            }
            div.innerHTML = `${imgHtml}<div class="item-title">${getName(item)}</div><div class="item-id">ID: ${bgmId}</div>${urlHtml}`;
            function toggle() {
                if (!bgmId) {
                    console.log('无效ID，无法选中');
                    return;
                }
                if (selectedIds.includes(bgmId)) {
                    selectedIds = selectedIds.filter(i => i !== bgmId);
                    delete selectedTypes[bgmId];
                    div.classList.remove('selected');
                    console.log('取消选中:', bgmId);
                } else {
                    selectedIds.push(bgmId);
                    selectedTypes[bgmId] = document.getElementById('default-type').value;
                    div.classList.add('selected');
                    console.log('选中:', bgmId);
                }
                renderSelectedList();
            }
            const img = div.querySelector('img');
            if (img) img.onclick = function(e) {
                e.stopPropagation();
                toggle();
            };
            div.querySelector('.item-title').onclick = function(e) {
                e.stopPropagation();
                toggle();
            };
            div.onclick = function(e) {
                // 只在点击图片或标题时触发
                if (e.target === img || e.target === div.querySelector('.item-title')) {
                    toggle();
                }
            };
            if (selectedIds.includes(bgmId)) {
                div.classList.add('selected');
            }
            return div;
        }
        function loadData() {
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;
            fetch(`/api/data?year=${year}&month=${month}`)
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('item-list');
                    list.innerHTML = '';
                    selectedIds = [];
                    itemMap = {};
                    selectedTypes = {};
                    if (data.data && data.data.length > 0) {
                        document.getElementById('img-size-controls').style.display = '';
                        data.data.forEach(item => {
                            const bgmId = getBgmId(item);
                            if (bgmId) itemMap[bgmId] = item;
                            list.appendChild(renderItem(item));
                        });
                    } else {
                        document.getElementById('img-size-controls').style.display = 'none';
                        list.innerHTML = '无数据';
                    }
                    // 初始容器宽度
                    document.getElementById('item-list').style.gridTemplateColumns = `repeat(auto-fill, minmax(${imgSize + 80}px, 1fr))`;
                    renderSelectedList();
                });
        }
        function addMonthAndReload() {
            let monthInput = document.getElementById('month');
            let month = parseInt(monthInput.value);
            if (month < 12) {
                monthInput.value = month + 1;
            } else {
                monthInput.value = 1;
                let yearInput = document.getElementById('year');
                yearInput.value = parseInt(yearInput.value) + 1;
            }
            loadData();
        }
    </script>
</body>
</html>
