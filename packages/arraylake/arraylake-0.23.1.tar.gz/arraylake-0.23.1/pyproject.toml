[build-system]
requires = ["hatchling", "hatch-vcs", "hatch-min-requirements"]
build-backend = "hatchling.build"

[tool.hatch.metadata.hooks.min_requirements]

[tool.hatch]
version.source = "vcs"
version.raw-options = { root = "../" }
build.hooks.vcs.version-file = "arraylake/_version.py"

[tool.hatch.build.targets.wheel]
packages = ["arraylake"]

[tool.hatch.metadata]
allow-direct-references = true

[project]
name = "arraylake"
description = "Python client for ArrayLake"
readme = { file = "README.md", content-type = "text/markdown" }
authors = [
  { name = "Joseph Hamman", email = "joe@earthmover.io" },
]
requires-python = ">=3.11,<3.14"
dynamic = ["version"]
license = "MIT"
keywords = []
classifiers = [
  "Programming Language :: Python",
  "Programming Language :: Python :: 3.11",
  "Programming Language :: Python :: 3.12",
  "Programming Language :: Python :: 3.13",
]
dependencies = [
  "aiobotocore[boto3] >= 2.10.0, <3.0",
  "aioitertools ~= 0.11",
  "boto3 >= 1.33.2, <2.0",
  "botocore >= 1.33.2",
  "cachetools >= 5.3.2, <6.0",
  "click>=8.1.3, <8.2",
  "donfig >=0.7, <1.0",
  "fsspec >= 2024.2.0",
  "gcsfs >= 2024.2.0",
  "httpx >= 0.23, < 0.28",
  "humanize ~= 4.9.0",
  "numcodecs >= 0.13.1",
  "numpy >= 1.23, <3.0",
  "packaging >= 23.0",
  "pydantic[email] >= 2.9, <2.10",
  "rich >=12.6, <14.0",
  "ruamel-yaml ~= 0.17",
  "s3fs >= 2024.02.0",
  "sqlitedict ~= 2.1",
  "structlog >= 24.1, <26.0",
  "tenacity >= 8.4.1, <9.0",
  "typer >= 0.12.0, <1.0",
  "zarr >= 2.18, !=3.0.3, !=3.0.5, !=3.0.7",
]

[project.optional-dependencies]
virtual = [
  "kerchunk >=0.2.8, <0.3",
  "tifffile >= 2023.2.27",
  "h5py",
  "imagecodecs"
]
grib = [
  "kerchunk >=0.2.8, <0.3",
  "cfgrib ~=0.9",
  "eccodes >= 2.37",
]
widgets = [
  "ipytree ~= 0.2.2"
]
xarray = [
  "xarray >= 2024.10.0",
  "cf_xarray >= 0.10.4",
]
maximal = [
  "netCDF4 >= 1.6.1, <2.0",
  "rioxarray ~= 0.15",
  "pandas ~= 2.0",
  "dask >= 2022.10.2",
  "distributed >= 2022.10.2",
  "scipy ~= 1.10",
  "xarray >= 2024.10.0",
]
icechunk = [
  "icechunk >= 1.0.0, < 2.0.0"
]
# TODO: move to dependency group once pip supports it
minicechunk = [
  "icechunk==1.0.0",
  "numpy==1.25",  # min zarr 3 numpy
  "zarr==3.0.0",
]

[project.scripts]
arraylake = "arraylake.cli.main:app"
al = "arraylake.cli.main:app"

[project.urls]
Documentation = "https://docs.earthmover.io/"
Changelog = "https://docs.earthmover.io/changelog"

[tool.hatch.envs.dev]
extra-dependencies = [
  "arraylake-mongo-metastore @ {root:parent:uri}/mongo-metastore",
  "boto3 ~= 1.24",
  "boto3-stubs ~= 1.34.30",
  "cloudpickle ~= 3.0.0",
  "hypothesis >= 6.88.1",
  "motor-types ~= 1.0.0b3",
  "mypy ~= 1.11",
  "pooch ~= 1.6.0",
  "pytest ~= 7.3",
  "pytest-asyncio ~= 0.21.1",
  "pytest-click ~= 1.1.0",
  "pytest-cov ~= 4.0.0",
  "pytest-incremental ~= 0.6.0",
  "pytest-lazy-fixture ~= 0.6.3",
  "pytest-reportlog ~= 0.4.0",
  "pytest-retry ~= 1.6.2",
  "pytest-timeout ~= 2.1.0",
  "pytest-xdist ~= 3.5.0",
  "pyyaml ~= 6.0.1",
  "respx ~= 0.20.1",
  "types-cachetools ~= 5.3",
  "types-python-dateutil ~= 2.8.19",
  "types-pyyaml ~= 6.0.12",
  "types-urllib3 ~= 1.26.25",
]

[tool.hatch.envs.dev.scripts]
install-arraylake = "python -m pip install . --no-deps"
install-metastore = "python -m pip install ../mongo-metastore --no-deps"
describe-env = "python --version && hatch --version && pip list && python -c 'import arraylake; print(arraylake.__version__)'"
type-check = "mypy ."
run-tests = "pytest -v --cov=. --cov-report=term-missing --cov-report=xml --cov-config=pyproject.toml -n 2 tests"
run-slow-tests = "pytest -n 2 -m slow -v --runslow --cov-append --cov=. --cov-report=term-missing --cov-report=xml --cov-config=pyproject.toml"

[tool.hatch.envs.standard]
template = "dev"
features = ["widgets", "virtual", "grib", "xarray", "maximal"]

[tool.hatch.envs.minimal-latest-python]
python = "3.13"
template = "dev"
features = ["widgets", "virtual", "xarray", "maximal"]

[tool.hatch.envs.icechunk]
python = "3.11"
template = "dev"
features = ["icechunk", "xarray"]

[tool.hatch.envs.upstream]
python = "3.13"
template = "standard"

[tool.hatch.envs.upstream.env-vars]
PIP_INDEX_URL = "https://pypi.anaconda.org/scientific-python-nightly-wheels/simple/"
PIP_EXTRA_INDEX_URL = "https://pypi.org/simple/"
PIP_PRE = "1"

[tool.hatch.envs.minimal]
python = "3.11"
skip-install = true
template = "dev"
features = ["min-reqs"]  # dynamically set by hatch-min-requirements

[tool.hatch.envs.minimal-icechunk]
python = "3.11"
template = "dev"
features = ["min-reqs"]  # dynamically set by hatch-min-requirements

[tool.hatch.envs.minimal-icechunk.scripts]
install-min-icechunk = "python -m pip install --upgrade-strategy only-if-needed .[minicechunk]"

[tool.hatch.envs.performance]
extra-dependencies = [
  "locust >=2.16",
  "xarray >=2023.12",
  "pandas >=1.3",
  "dask >=2023.10",
  "distributed >=2023.10",
  "xbatcher >=0.3.0",
  "ipython >=7"
]

[tool.coverage.run]
branch = true
source = ["arraylake/*"]
include = ["arraylake/*"]
omit = ["tests/*", "**/__init__.py", "**/__main__.py", "arraylake/token.py", "arraylake/cli/auth.py"]

[tool.coverage.report]
include = ["arraylake/*"]

[tool.pytest.ini_options]
markers = ["slow: mark test as slow", "add_object_store: add object store backend to test"]
norecursedirs = ["tests/helpers"]
filterwarnings = [
  'ignore:.*pkg_resources.*:DeprecationWarning',
  'ignore:.*make_current is deprecated; start the event loop first.*:DeprecationWarning',
  'ignore:.*no current event loop.*:DeprecationWarning',
  'error:ZARR_V3_EXPERIMENTAL_API must be set before importing the arraylake client .*:UserWarning',
  'ignore:The experimental Zarr V3 implementation .*:FutureWarning'
]
asyncio_mode = "auto"

[tool.mypy]
warn_unused_configs = true
warn_redundant_casts = true
warn_unused_ignores = true
strict_equality = true
extra_checks = true
check_untyped_defs = true
disallow_subclassing_any = true
disallow_untyped_decorators = true
#disallow_any_generics = true  #TODO
exclude = [
  '^tests/',  # TOML literal string (single-quotes, no escaping necessary)
  '^flycheck_\.',  # for emacs
  'validate_export.py',  # mypy fails for zarr-v3
  'arraylake/cli/export.py',  # mypy fails for zarr-v3
]

# TODO: mypy improvements for these
[[tool.mypy.overrides]]
ignore_missing_imports = true
module=[
"aiobotocore.*",
"botocore",
"cfgrib.*",
"donfig",
"fsspec.*",
"gcsfs",
"icechunk",
"kerchunk.*",
"ipytree",
"sqlitedict",
"s3fs",
"types_aiobotocore_s3",
"uvloop",
"zarr.*",
]
