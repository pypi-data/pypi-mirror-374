name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-and-build:
    name: Test and Build Package
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v3

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Run tests
      run: |
        uv run pytest tests/unit/ -v

    - name: Run linting
      run: |
        uv run ruff check .

    - name: Build package
      run: |
        uv build

    - name: Test uvx distribution
      run: |
        uvx --from ./dist/epic_llm-*.whl epic-llm --help
        uvx --from ./dist/epic_llm-*.whl epic-llm list

    - name: Upload package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-package
        path: dist/

  release:
    name: Create Release
    needs: test-and-build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/checkout@v4

    - name: Download package
      uses: actions/download-artifact@v4
      with:
        name: python-package
        path: dist/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.whl
          dist/*.tar.gz
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Epic LLM Release
          
          ### üöÄ Installation Options
          
          **Option 1: Run without installation (Recommended)**
          ```bash
          # Run Epic LLM directly with uvx - no installation needed!
          uvx epic-llm --help
          uvx epic-llm check
          uvx epic-llm start
          ```
          
          **Option 2: Install Epic LLM**
          ```bash
          # Install with uv (recommended)
          uv tool install epic-llm
          
          # Or install with pip
          pip install epic-llm
          ```
          
          **Option 3: Install from release files**
          ```bash
          # Download the .whl file from this release, then:
          uvx --from ./epic_llm-*.whl epic-llm --help
          ```
          
          ### üìñ Quick Start
          
          ```bash
          # Check what's needed
          uvx epic-llm check
          
          # Install third-party provider tools
          uvx epic-llm check --install
          
          # Start all providers
          uvx epic-llm start
          ```
          
          ### ‚ö†Ô∏è Legal Notice
          Epic LLM is an orchestration tool that manages third-party repositories created by independent developers. Users must manually download third-party tools at their own discretion. Epic LLM does not bundle, distribute, or provide any third-party tools. See README for full legal disclaimers.
          
          ### üõ†Ô∏è What's New
          Check the commit history for detailed changes in this release.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Publish to PyPI
  # Uncomment this job if you want to publish to PyPI
  # publish-pypi:
  #   name: Publish to PyPI
  #   needs: test-and-build
  #   runs-on: ubuntu-latest
  #   if: startsWith(github.ref, 'refs/tags/')
  #   
  #   steps:
  #   - name: Download package
  #     uses: actions/download-artifact@v4
  #     with:
  #       name: python-package
  #       path: dist/
  #   
  #   - name: Publish to PyPI
  #     uses: pypa/gh-action-pypi-publish@release/v1
  #     with:
  #       password: ${{ secrets.PYPI_API_TOKEN }}