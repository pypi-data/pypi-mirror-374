import{ab as ke,ac as et,ad as $e,d as tt,s as at,x as nt,y as he,v as st,r as v,ae as rt,af as ne,z as be,W as ot,c as J,b as g,A as lt,e as q,w as se,g as ve,t as P,n as _e,q as re,m as ut,P as it,Q as ct,D as we,h as ft,M as pt,ag as dt,j as Ae,ah as ht,ai as vt,o as L,aj as gt,ak as mt}from"./index-DeXzsHYB.js";import{b as yt}from"./label-BkejwNG2.js";import{_ as bt}from"./_plugin-vue_export-helper-DlAUqK2U.js";var Fe={exports:{}};(function(z,E){(function(A){z.exports=A()})(function(A){var $=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function b(o,s){var t=o[0],e=o[1],n=o[2],a=o[3];t+=(e&n|~e&a)+s[0]-680876936|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+s[1]-389564586|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+s[2]+606105819|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+s[3]-1044525330|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+s[4]-176418897|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+s[5]+1200080426|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+s[6]-1473231341|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+s[7]-45705983|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+s[8]+1770035416|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+s[9]-1958414417|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+s[10]-42063|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+s[11]-1990404162|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+s[12]+1804603682|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+s[13]-40341101|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+s[14]-1502002290|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+s[15]+1236535329|0,e=(e<<22|e>>>10)+n|0,t+=(e&a|n&~a)+s[1]-165796510|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+s[6]-1069501632|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+s[11]+643717713|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+s[0]-373897302|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+s[5]-701558691|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+s[10]+38016083|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+s[15]-660478335|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+s[4]-405537848|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+s[9]+568446438|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+s[14]-1019803690|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+s[3]-187363961|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+s[8]+1163531501|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+s[13]-1444681467|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+s[2]-51403784|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+s[7]+1735328473|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+s[12]-1926607734|0,e=(e<<20|e>>>12)+n|0,t+=(e^n^a)+s[5]-378558|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+s[8]-2022574463|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+s[11]+1839030562|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+s[14]-35309556|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+s[1]-1530992060|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+s[4]+1272893353|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+s[7]-155497632|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+s[10]-1094730640|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+s[13]+681279174|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+s[0]-358537222|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+s[3]-722521979|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+s[6]+76029189|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+s[9]-640364487|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+s[12]-421815835|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+s[15]+530742520|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+s[2]-995338651|0,e=(e<<23|e>>>9)+n|0,t+=(n^(e|~a))+s[0]-198630844|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+s[7]+1126891415|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+s[14]-1416354905|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+s[5]-57434055|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+s[12]+1700485571|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+s[3]-1894986606|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+s[10]-1051523|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+s[1]-2054922799|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+s[8]+1873313359|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+s[15]-30611744|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+s[6]-1560198380|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+s[13]+1309151649|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+s[4]-145523070|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+s[11]-1120210379|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+s[2]+718787259|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+s[9]-343485551|0,e=(e<<21|e>>>11)+n|0,o[0]=t+o[0]|0,o[1]=e+o[1]|0,o[2]=n+o[2]|0,o[3]=a+o[3]|0}function F(o){var s=[],t;for(t=0;t<64;t+=4)s[t>>2]=o.charCodeAt(t)+(o.charCodeAt(t+1)<<8)+(o.charCodeAt(t+2)<<16)+(o.charCodeAt(t+3)<<24);return s}function Q(o){var s=[],t;for(t=0;t<64;t+=4)s[t>>2]=o[t]+(o[t+1]<<8)+(o[t+2]<<16)+(o[t+3]<<24);return s}function I(o){var s=o.length,t=[1732584193,-271733879,-1732584194,271733878],e,n,a,y,S,w;for(e=64;e<=s;e+=64)b(t,F(o.substring(e-64,e)));for(o=o.substring(e-64),n=o.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)a[e>>2]|=o.charCodeAt(e)<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(b(t,a),e=0;e<16;e+=1)a[e]=0;return y=s*8,y=y.toString(16).match(/(.*?)(.{0,8})$/),S=parseInt(y[2],16),w=parseInt(y[1],16)||0,a[14]=S,a[15]=w,b(t,a),t}function Z(o){var s=o.length,t=[1732584193,-271733879,-1732584194,271733878],e,n,a,y,S,w;for(e=64;e<=s;e+=64)b(t,Q(o.subarray(e-64,e)));for(o=e-64<s?o.subarray(e-64):new Uint8Array(0),n=o.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)a[e>>2]|=o[e]<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(b(t,a),e=0;e<16;e+=1)a[e]=0;return y=s*8,y=y.toString(16).match(/(.*?)(.{0,8})$/),S=parseInt(y[2],16),w=parseInt(y[1],16)||0,a[14]=S,a[15]=w,b(t,a),t}function k(o){var s="",t;for(t=0;t<4;t+=1)s+=$[o>>t*8+4&15]+$[o>>t*8&15];return s}function B(o){var s;for(s=0;s<o.length;s+=1)o[s]=k(o[s]);return o.join("")}B(I("hello")),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function o(s,t){return s=s|0||0,s<0?Math.max(s+t,0):Math.min(s,t)}ArrayBuffer.prototype.slice=function(s,t){var e=this.byteLength,n=o(s,e),a=e,y,S,w,U;return t!==A&&(a=o(t,e)),n>a?new ArrayBuffer(0):(y=a-n,S=new ArrayBuffer(y),w=new Uint8Array(S),U=new Uint8Array(this,n,y),w.set(U),S)}}();function W(o){return/[\u0080-\uFFFF]/.test(o)&&(o=unescape(encodeURIComponent(o))),o}function H(o,s){var t=o.length,e=new ArrayBuffer(t),n=new Uint8Array(e),a;for(a=0;a<t;a+=1)n[a]=o.charCodeAt(a);return s?n:e}function oe(o){return String.fromCharCode.apply(null,new Uint8Array(o))}function N(o,s,t){var e=new Uint8Array(o.byteLength+s.byteLength);return e.set(new Uint8Array(o)),e.set(new Uint8Array(s),o.byteLength),e}function x(o){var s=[],t=o.length,e;for(e=0;e<t-1;e+=2)s.push(parseInt(o.substr(e,2),16));return String.fromCharCode.apply(String,s)}function h(){this.reset()}return h.prototype.append=function(o){return this.appendBinary(W(o)),this},h.prototype.appendBinary=function(o){this._buff+=o,this._length+=o.length;var s=this._buff.length,t;for(t=64;t<=s;t+=64)b(this._hash,F(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},h.prototype.end=function(o){var s=this._buff,t=s.length,e,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],a;for(e=0;e<t;e+=1)n[e>>2]|=s.charCodeAt(e)<<(e%4<<3);return this._finish(n,t),a=B(this._hash),o&&(a=x(a)),this.reset(),a},h.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},h.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},h.prototype.setState=function(o){return this._buff=o.buff,this._length=o.length,this._hash=o.hash,this},h.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},h.prototype._finish=function(o,s){var t=s,e,n,a;if(o[t>>2]|=128<<(t%4<<3),t>55)for(b(this._hash,o),t=0;t<16;t+=1)o[t]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(e[2],16),a=parseInt(e[1],16)||0,o[14]=n,o[15]=a,b(this._hash,o)},h.hash=function(o,s){return h.hashBinary(W(o),s)},h.hashBinary=function(o,s){var t=I(o),e=B(t);return s?x(e):e},h.ArrayBuffer=function(){this.reset()},h.ArrayBuffer.prototype.append=function(o){var s=N(this._buff.buffer,o),t=s.length,e;for(this._length+=o.byteLength,e=64;e<=t;e+=64)b(this._hash,Q(s.subarray(e-64,e)));return this._buff=e-64<t?new Uint8Array(s.buffer.slice(e-64)):new Uint8Array(0),this},h.ArrayBuffer.prototype.end=function(o){var s=this._buff,t=s.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n,a;for(n=0;n<t;n+=1)e[n>>2]|=s[n]<<(n%4<<3);return this._finish(e,t),a=B(this._hash),o&&(a=x(a)),this.reset(),a},h.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},h.ArrayBuffer.prototype.getState=function(){var o=h.prototype.getState.call(this);return o.buff=oe(o.buff),o},h.ArrayBuffer.prototype.setState=function(o){return o.buff=H(o.buff,!0),h.prototype.setState.call(this,o)},h.ArrayBuffer.prototype.destroy=h.prototype.destroy,h.ArrayBuffer.prototype._finish=h.prototype._finish,h.ArrayBuffer.hash=function(o,s){var t=Z(new Uint8Array(o)),e=B(t);return s?x(e):e},h})})(Fe);var _t=Fe.exports;const wt=ke(_t);function At(...z){const E=[];return z.forEach($=>{if($){const{cleanup:b}=et($);E.push(b)}}),$e(()=>{E.forEach($=>$())}),{cleanup:()=>{E.forEach($=>$())}}}function Se(z){return At(z)}const St={class:"upload-page-container"},Ct={class:"main-container"},$t={class:"upload-content",style:{position:"relative"}},Ft={key:0,class:"simple-loading-overlay"},jt={class:"loading-content"},Bt={class:"progress-text"},xt={class:"upload-icon"},Et={class:"upload-progress-container"},It={class:"stat-item",style:{width:"50%"}},Tt={class:"stat-value"},Lt={class:"stat-item",style:{width:"50%"}},Nt={class:"success-value"},Ut={class:"upload-progress"},Mt={key:1,class:"empty-progress"},Dt={class:"upload-actions"},Rt={class:"right-sidebar"},Ot=["innerHTML"],Jt={key:1},Ce="application/json",Pt=tt({__name:"UploadSample",setup(z){const E=at(),{currentProject:A}=nt(E);he(()=>{var r;return(r=A.value)==null?void 0:r.id});const $=he(()=>{var r;return(r=A.value)==null?void 0:r.type}),b=he(()=>{var r;return((r=A.value)==null?void 0:r.image_type)||0}),F=st(),Q=ft(),I=v([]),Z=v(0),k=v(0),B=v(0),W=v(0),H=v(0),oe=v(0),N=v(0),x=v(0),h=v(0),o=v(0),s=v(),t=v(!1),e=v([]),n=v(!1);let a=null;Se(t);const{on:y,off:S}=rt(),w=()=>{n.value=!0,a&&(a.abort(),a=null),d("由于登录状态失效，上传已中断"),m.value&&(m.value=!1,d("由于登录状态失效，文件处理已中断"),s.value&&(s.value.value=""),T.value=0,K.value=0,M.value="")};y(ne.TOKEN_EXPIRED,w),y(ne.TOKEN_CONFLICT,w);let U=null;const ee=v("color"),le=v(!1),je=v(null),Y=v([]),te=v(null),m=v(!1),M=v(""),T=v(0),K=v(0);Se(m);const D=v(new Map),j=v([]),_=v([]),Be=["image/jpeg","image/jpg","image/png","image/bmp"],G=v(new Map),ue=v(null),ie=v(null),xe=()=>{!m.value&&s.value&&s.value.click()},Ee=r=>{r.preventDefault()},Ie=r=>{var u;if(r.preventDefault(),m.value)return;const l=Array.from(((u=r.dataTransfer)==null?void 0:u.files)||[]);l.length>0&&ge(l)},Te=r=>{const l=r.target,u=Array.from(l.files||[]);u.length>0&&ge(u)},ge=async r=>{if(n.value){d("登录状态已失效，无法处理文件");return}m.value=!0,K.value=r.length,T.value=0,M.value=`开始处理 ${r.length} 个文件...`,await we(),j.value=[],_.value=[],I.value=[],G.value.clear(),D.value.clear();const l=10;for(let u=0;u<r.length;u+=l){const p=r.slice(u,u+l);for(const c of p)await Le(c),T.value++,M.value=`正在处理文件... (${T.value}/${K.value})`;await new Promise(c=>setTimeout(c,10))}if(await Xe(),n.value){d(`文件处理已中断：共处理 ${T.value} 个文件`),m.value=!1;return}Re(),Z.value=j.value.length,Pe(),M.value="文件处理完成！",setTimeout(()=>{m.value=!1},500)},Le=async r=>{if(!Be.includes(r.type)&&r.type!==Ce){d(`不支持的文件类型: ${r.name}，仅支持jpeg/jpg、png、bmp和json格式`);return}if(r.type===Ce){if(r.name==="label.json"){ue.value=r;return}if(r.name==="background.json"){ie.value=r;return}if(!_.value.some(l=>l.name===r.name)){_.value.push(r);try{const l=await Ne(r),u=JSON.parse(l);r.labelList=Ue(u)}catch{d(`解析JSON文件 ${r.name} 失败`)}}return}try{await Oe(r)}catch{d(`处理图片 ${r.name} 时出错`)}},Ne=r=>new Promise((l,u)=>{const p=new FileReader;p.onload=c=>{var i;return l((i=c.target)==null?void 0:i.result)},p.onerror=()=>u(new Error("读取文件失败")),p.readAsText(r)}),Ue=r=>{const l=new Set;if($.value==="分类")r.classfication&&l.add(r.classfication.labelName);else for(const u of Object.keys(r))Array.isArray(r[u])&&r[u].forEach(p=>{p.labelName&&l.add(p.labelName)});return Array.from(l)},Me=()=>{m.value=!1,s.value&&(s.value.value=""),j.value=[],_.value=[],I.value=[],Z.value=0,G.value.clear(),D.value.clear(),T.value=0,K.value=0,M.value="",d("文件处理已取消")},me=r=>{if(t.value){const l="上传正在进行中，刷新页面将中断上传进程。是否确定要离开？";return r.preventDefault(),r.returnValue=l,l}},De=()=>{window.addEventListener("beforeunload",me)},ce=()=>{window.removeEventListener("beforeunload",me)},Re=()=>{if(j.value.length===0)return;const r=new Map,l=new Map,u=new Set;if(_.value.length>0)for(const p of _.value){if(!p)continue;const c=p.name;let i="";if(c.endsWith(".mix.json"))i=c.substring(0,c.lastIndexOf(".mix.json"));else if(c.endsWith(".json"))i=c.substring(0,c.lastIndexOf(".json"));else{console.warn(`未知的JSON文件格式: ${c}`);continue}l.set(i,p)}for(const p of j.value){if(!p)continue;const c=p.name.substring(0,p.name.lastIndexOf(".")),i=l.get(c)||null;r.set(c,{image:p,json:i}),i&&u.add(c)}for(const[p,c]of l.entries())u.has(p)||r.has(p)||(r.set(p,{image:null,json:c}),d(`警告：${p} 只有JSON文件，缺少对应的图片文件`));D.value=r},Oe=async r=>{try{const l=await ye(r);if(Array.from(G.value.keys()).includes(l)){const u=G.value.get(l);d(`发现重复图片: ${r.name}，与 ${u} 内容相同，已丢弃`),H.value++,Je(r.name);return}j.value.push(r),G.value.set(l,r.name)}catch(l){if(l.message==="MD5计算被中断")return;console.error(`处理图片 ${r.name} 时出错:`,l)}},Je=r=>{const l=r.substring(0,r.lastIndexOf(".")),u=_.value.findIndex(p=>{let c="";const i=p.name;return i.endsWith(".mix.json")?c=i.substring(0,i.lastIndexOf(".mix.json")):i.endsWith(".json")&&(c=i.substring(0,i.lastIndexOf(".json"))),c===l});if(u!==-1){const p=_.value[u];_.value.splice(u,1),d(`同时移除对应的JSON文件: ${p.name}`);const c=I.value.findIndex(i=>i.name===p.name);c!==-1&&I.value.splice(c,1)}},V=v(new Set),fe=()=>{V.value.forEach(r=>{try{r.abort()}catch{}}),V.value.clear()},ye=r=>new Promise((l,u)=>{const p=File.prototype.slice,c=2097152,i=Math.ceil(r.size/c);let f=0;const X=new wt.ArrayBuffer,C=new FileReader;V.value.add(C),C.onload=O=>{if(n.value){V.value.delete(C),u(new Error("MD5计算被中断"));return}if(X.append(O.target.result),f++,f<i)R();else{const de=X.end();V.value.delete(C),l(de)}},C.onerror=O=>{V.value.delete(C),u(O)};function R(){const O=f*c,de=O+c>=r.size?r.size:O+c;C.readAsArrayBuffer(p.call(r,O,de))}R()}),Pe=()=>{if(j.value.length>0){const r=j.value.length===1?`已选择 1 张图片: ${j.value[0].name}`:`已选择 ${j.value.length} 张图片`;_.value.length>0?pe(`${r}, ${_.value.length} 个JSON文件`):pe(r)}else _.value.length>0&&pe(`已选择 ${_.value.length} 个JSON文件，没有选择图片`)},pe=r=>{const l=Y.value.findIndex(u=>u.startsWith("已选择"));l!==-1?Y.value[l]=r:Y.value.unshift(r)},ze=()=>{const r=[];for(const[l,u]of D.value.entries())u.image&&r.push(u.image);return r},We=()=>{var l;return Array.from(D.value.values()).some(u=>u.image!==null)?(l=A.value)!=null&&l.id?!0:(d("请先选择项目"),!1):(d("请先选择要上传的文件"),!1)},He=async r=>{if(n.value)return!1;if(!r)return d("文件对象无效，跳过此文件"),!1;const l=await ye(r),u=new FormData;u.append("name",r.name),u.append("md5",l),u.append("project_id",String(A.value.id)),u.append("file",r);const p=r.name.substring(0,r.name.lastIndexOf(".")),c=D.value.get(p);if(c!=null&&c.json){const i=c.json,f=i.labelList;u.append("annotation_file",i),f&&Array.isArray(f)&&f.length>0&&u.append("label_names",f.join(","))}e.value.length!==0&&u.append("tag_names",e.value.join(","));try{const i=await mt(u,a==null?void 0:a.signal);if(i.data.code===200)return d(`${r.name} 上传成功`),je.value=i.data.data.id.toString(),E.setHasSampleImage(!0),!0;{const f=i.data.msg||"";return f.includes("已存在")||f.includes("重复")||f.includes("exist")?(N.value++,d(`${r.name} 上传失败: 文件已存在`)):f.includes("格式")||f.includes("format")||f.includes("类型")?(h.value++,d(`${r.name} 上传失败: 格式错误 - ${f}`)):(o.value++,d(`${r.name} 上传失败: ${f}`)),!1}}catch(i){if(i.name==="AbortError"||i.code==="ERR_CANCELED"||n.value)return!1;const f=i.message||"";return f.includes("网络")||f.includes("network")||f.includes("timeout")||i.code==="NETWORK_ERROR"?(x.value++,d(`${r.name} 上传出错: 网络错误`)):(o.value++,d(`${r.name} 上传出错: ${f}`)),!1}},Ke=()=>{U=Q.beforeEach((r,l,u)=>{const p=F.isUploading,c=F.showUploadingTip,i=p&&c||m.value;if(l.path.includes("/sample/upload")&&i&&!n.value){const f=m.value?"当前正在处理文件，离开页面将中断处理。是否确认离开？":"当前有上传任务正在进行中，离开页面将中断上传。是否确认离开？";pt.confirm(f,"提示",{confirmButtonText:"确认离开",cancelButtonText:"取消",type:"warning"}).then(()=>{n.value=!0,m.value&&(fe(),m.value=!1),ae(!1),u()}).catch(()=>{u(!1)})}else n.value&&ae(!1),u()})},Ge=()=>{U&&(U(),U=null)},ae=(r=!0)=>{t.value=!1,m.value&&(fe(),m.value=!1,T.value=0,K.value=0,M.value=""),r&&(n.value=!1),a&&(a=null),F.clearUploadingStatus(),F.clearShowUploadingTip(),B.value=0,j.value=[],_.value=[],G.value.clear(),D.value.clear(),I.value=[],W.value=0,H.value=0,oe.value=0,N.value=0,x.value=0,h.value=0,o.value=0,s.value&&(s.value.value=""),d("文件列表已重置，可以继续上传新文件")},Ve=()=>{n.value=!1},Xe=async()=>{try{await dt()}catch(r){console.error("检查token状态时出错:",r)}},qe=async()=>{var r;if(ue.value)try{const l=new FileReader,u=await new Promise((f,X)=>{l.onload=C=>{var R;return f((R=C.target)==null?void 0:R.result)},l.onerror=C=>X(C),l.readAsText(ue.value)}),p=JSON.parse(u);if(!Array.isArray(p)){d("label.json 格式错误，应为标签数组");return}const c=p.map(f=>({name:f.name,color:f.color||[255,0,0,255]}));if(c.length===0){d("label.json 中没有有效的标签数据");return}const i=await yt({project_id:Number(((r=A.value)==null?void 0:r.id)||0),labels:c});i.data.code===200?d("成功创建类别"):d(`创建类别失败: ${i.data.msg}`)}catch(l){d(`处理 label.json 文件失败: ${l.message}`)}},Qe=async()=>{var l;if(!We())return;if(n.value){d("登录状态已失效，无法开始上传，请重新登录");return}n.value=!1,a=new AbortController,t.value=!0,F.setUploadingStatus(!0),F.setShowUploadingTip(!0),De();let r=0;try{await qe();const u=ze(),p=u.length;if(p===0){d("当前没有可上传的图像"),t.value=!1,F.clearUploadingStatus(),F.clearShowUploadingTip(),ce();return}d(`开始上传 ${p} 个图像`);for(const[f,X]of u.entries()){if(n.value){d(`上传已中断：共处理 ${f} 张图片，成功 ${r} 张`);break}await He(X)&&(r++,k.value=r);const R=Math.floor((f+1)/p*100);B.value=Math.min(R,100)}if(ie.value&&!n.value){const f=new FormData;f.append("project_id",String(((l=A.value)==null?void 0:l.id)||0)),f.append("file",ie.value),await gt(f,a==null?void 0:a.signal)}r>0&&E.setHasSampleImage(!0);const c=N.value+x.value+h.value+o.value;let i=`📊 上传统计：总共${p}张，成功${r}张，失败${c}张`;if(c>0){const f=[];N.value>0&&f.push(`已存在${N.value}张`),x.value>0&&f.push(`网络错误${x.value}张`),h.value>0&&f.push(`格式错误${h.value}张`),o.value>0&&f.push(`其他错误${o.value}张`),f.length>0&&(i+=`（${f.join("，")}）`)}H.value>0&&(i+=`，重复${H.value}张`),W.value>0&&(i+=`，过滤器不匹配${W.value}张`),d(i,"statistics")}catch(u){u.name==="AbortError"||u.code==="ERR_CANCELED"?d("上传已被中断"):(d(`上传过程中发生错误: ${u.message}`),console.error("Upload error:",u))}finally{t.value&&(ce(),ae())}},Ze=r=>{if(typeof r=="object"&&r.type)return r.type;const l=typeof r=="string"?r:r.message;return l.includes("成功")||l.includes("已选择")?"success":l.includes("警告")||l.includes("重复")?"warning":l.includes("失败")||l.includes("错误")||l.includes("不匹配")||l.includes("重复")||l.includes("不支持")||l.includes("当前选择的是")&&l.includes("图像过滤器")?"error":""},Ye=r=>r.replace(/成功(\d+)张/g,'<span style="color: #67C23A; font-weight: bold;">成功$1张</span>').replace(/失败(\d+)张/g,'<span style="color: #F56C6C; font-weight: bold;">失败$1张</span>').replace(/已存在(\d+)张/g,'<span style="color: #FF6B35; font-weight: bold;">已存在$1张</span>').replace(/网络错误(\d+)张/g,'<span style="color: #FF4757; font-weight: bold;">网络错误$1张</span>').replace(/格式错误(\d+)张/g,'<span style="color: #FF6348; font-weight: bold;">格式错误$1张</span>').replace(/其他错误(\d+)张/g,'<span style="color: #FF5722; font-weight: bold;">其他错误$1张</span>').replace(/重复(\d+)张/g,'<span style="color: #E6A23C; font-weight: bold;">重复$1张</span>').replace(/过滤器不匹配(\d+)张/g,'<span style="color: #E6A23C; font-weight: bold;">过滤器不匹配$1张</span>'),d=(r,l)=>{const u=l?{message:r,type:l}:r;Y.value.push(u),we(()=>{te.value&&(te.value.scrollTop=te.value.scrollHeight)})};return be(ee,(r,l)=>{r!==l&&d(`已切换到${r==="color"?"彩色":"灰度"}图像模式`)}),ot(()=>{Ve(),ee.value="color",le.value=!1,Number(b.value)===1?(ee.value="gray",le.value=!0):Number(b.value)===3&&(ee.value="color",le.value=!0),Ke()}),$e(()=>{Ge(),ce(),S(ne.TOKEN_EXPIRED,w),S(ne.TOKEN_CONFLICT,w),(t.value||m.value)&&(n.value=!0,m.value&&fe(),ae(!1))}),be(()=>Q.currentRoute.value.path,()=>{}),(r,l)=>{const u=ve("el-icon"),p=ve("el-button"),c=ve("el-progress");return L(),J("div",St,[g("div",Ct,[l[5]||(l[5]=g("div",{class:"tab-title"},[g("div",{class:"title-content"},[g("span",null,"图像上传")])],-1)),g("div",$t,[m.value?(L(),J("div",Ft,[g("div",jt,[q(u,{class:"is-loading",size:"24"},{default:se(()=>[q(Ae(ht))]),_:1}),g("p",null,P(M.value),1),g("p",Bt,P(T.value)+"/"+P(K.value),1),q(p,{onClick:Me,link:"",size:"small",style:{"margin-top":"12px"}},{default:se(()=>l[0]||(l[0]=[re(" 取消处理 ")])),_:1})])])):lt("",!0),g("div",{class:_e(["upload-area",{processing:m.value}])},[g("div",{class:"upload-drop-area",onClick:xe,onDrop:Ie,onDragover:Ee},[g("input",{ref_key:"fileInputRef",ref:s,type:"file",multiple:"",accept:"image/*,.json",onChange:Te,style:{display:"none"}},null,544),g("div",xt,[q(u,null,{default:se(()=>[q(Ae(vt))]),_:1})]),l[1]||(l[1]=g("div",{class:"upload-text"},[g("p",null,[re("将图像拖拽到此处，或者"),g("span",{class:"highlight"},"点击此处"),re("选择文件或文件夹")]),g("p",{class:"upload-format"},"支持的图像格式为: jpeg/jpg、png、bmp，单张图像大小不超过20M"),g("p",{class:"upload-tip"},"💡 提示：无论彩色或灰度图像，系统将统一按彩色模式进行训练处理")],-1))],32),g("div",Et,[g("div",It,[l[2]||(l[2]=g("span",{class:"stat-label"},"当次选中样本数",-1)),g("span",Tt,P(Z.value),1)]),g("div",Lt,[l[3]||(l[3]=g("span",{class:"stat-label"},"成功上传样本数",-1)),g("span",Nt,P(k.value),1)])]),g("div",Ut,[B.value>0?(L(),ut(c,{key:0,percentage:B.value,"stroke-width":10,"show-text":!1},null,8,["percentage"])):(L(),J("div",Mt))]),g("div",Dt,[q(p,{type:"primary",class:"upload-button",onClick:Qe,loading:t.value,disabled:t.value},{default:se(()=>[re(P(t.value?"上传中...":"上传"),1)]),_:1},8,["loading","disabled"])])],2)]),g("div",Rt,[l[4]||(l[4]=g("div",{class:"sidebar-header"},"上传日志",-1)),g("div",{class:"log-content",ref_key:"logContent",ref:te},[(L(!0),J(it,null,ct(Y.value,(i,f)=>(L(),J("div",{class:_e(["log-item",Ze(i)]),key:f},[typeof i=="object"&&i.type==="statistics"?(L(),J("span",{key:0,innerHTML:Ye(i.message)},null,8,Ot)):(L(),J("span",Jt,P(typeof i=="string"?i:i.message),1))],2))),128))],512)])])])}}}),Kt=bt(Pt,[["__scopeId","data-v-120e6c65"]]);export{Kt as default};
//# sourceMappingURL=UploadSample-eWKAMp4k.js.map
