import{ab as lt,ac as ut,ad as Ie,d as it,s as ct,x as ft,y as me,v as dt,r as v,ae as pt,af as ue,z as Se,W as vt,c as L,b as h,A as ht,e as O,w as Y,g as k,t as J,n as Ae,q as ie,m as Ce,P as $e,Q as Fe,D as je,h as gt,M as Te,ag as mt,j as xe,ah as yt,ai as bt,o as B,aj as _t,ak as wt}from"./index-o9GSe-j3.js";import{u as St}from"./tag-VQIGgSji.js";import{b as At}from"./label-NvfHJJOO.js";import{_ as Ct}from"./_plugin-vue_export-helper-DlAUqK2U.js";var Ue={exports:{}};(function(P,I){(function($){P.exports=$()})(function($){var F=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function S(o,s){var t=o[0],e=o[1],n=o[2],a=o[3];t+=(e&n|~e&a)+s[0]-680876936|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+s[1]-389564586|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+s[2]+606105819|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+s[3]-1044525330|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+s[4]-176418897|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+s[5]+1200080426|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+s[6]-1473231341|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+s[7]-45705983|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+s[8]+1770035416|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+s[9]-1958414417|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+s[10]-42063|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+s[11]-1990404162|0,e=(e<<22|e>>>10)+n|0,t+=(e&n|~e&a)+s[12]+1804603682|0,t=(t<<7|t>>>25)+e|0,a+=(t&e|~t&n)+s[13]-40341101|0,a=(a<<12|a>>>20)+t|0,n+=(a&t|~a&e)+s[14]-1502002290|0,n=(n<<17|n>>>15)+a|0,e+=(n&a|~n&t)+s[15]+1236535329|0,e=(e<<22|e>>>10)+n|0,t+=(e&a|n&~a)+s[1]-165796510|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+s[6]-1069501632|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+s[11]+643717713|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+s[0]-373897302|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+s[5]-701558691|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+s[10]+38016083|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+s[15]-660478335|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+s[4]-405537848|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+s[9]+568446438|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+s[14]-1019803690|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+s[3]-187363961|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+s[8]+1163531501|0,e=(e<<20|e>>>12)+n|0,t+=(e&a|n&~a)+s[13]-1444681467|0,t=(t<<5|t>>>27)+e|0,a+=(t&n|e&~n)+s[2]-51403784|0,a=(a<<9|a>>>23)+t|0,n+=(a&e|t&~e)+s[7]+1735328473|0,n=(n<<14|n>>>18)+a|0,e+=(n&t|a&~t)+s[12]-1926607734|0,e=(e<<20|e>>>12)+n|0,t+=(e^n^a)+s[5]-378558|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+s[8]-2022574463|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+s[11]+1839030562|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+s[14]-35309556|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+s[1]-1530992060|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+s[4]+1272893353|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+s[7]-155497632|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+s[10]-1094730640|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+s[13]+681279174|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+s[0]-358537222|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+s[3]-722521979|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+s[6]+76029189|0,e=(e<<23|e>>>9)+n|0,t+=(e^n^a)+s[9]-640364487|0,t=(t<<4|t>>>28)+e|0,a+=(t^e^n)+s[12]-421815835|0,a=(a<<11|a>>>21)+t|0,n+=(a^t^e)+s[15]+530742520|0,n=(n<<16|n>>>16)+a|0,e+=(n^a^t)+s[2]-995338651|0,e=(e<<23|e>>>9)+n|0,t+=(n^(e|~a))+s[0]-198630844|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+s[7]+1126891415|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+s[14]-1416354905|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+s[5]-57434055|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+s[12]+1700485571|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+s[3]-1894986606|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+s[10]-1051523|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+s[1]-2054922799|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+s[8]+1873313359|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+s[15]-30611744|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+s[6]-1560198380|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+s[13]+1309151649|0,e=(e<<21|e>>>11)+n|0,t+=(n^(e|~a))+s[4]-145523070|0,t=(t<<6|t>>>26)+e|0,a+=(e^(t|~n))+s[11]-1120210379|0,a=(a<<10|a>>>22)+t|0,n+=(t^(a|~e))+s[2]+718787259|0,n=(n<<15|n>>>17)+a|0,e+=(a^(n|~t))+s[9]-343485551|0,e=(e<<21|e>>>11)+n|0,o[0]=t+o[0]|0,o[1]=e+o[1]|0,o[2]=n+o[2]|0,o[3]=a+o[3]|0}function G(o){var s=[],t;for(t=0;t<64;t+=4)s[t>>2]=o.charCodeAt(t)+(o.charCodeAt(t+1)<<8)+(o.charCodeAt(t+2)<<16)+(o.charCodeAt(t+3)<<24);return s}function j(o){var s=[],t;for(t=0;t<64;t+=4)s[t>>2]=o[t]+(o[t+1]<<8)+(o[t+2]<<16)+(o[t+3]<<24);return s}function ee(o){var s=o.length,t=[1732584193,-271733879,-1732584194,271733878],e,n,a,y,m,b;for(e=64;e<=s;e+=64)S(t,G(o.substring(e-64,e)));for(o=o.substring(e-64),n=o.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)a[e>>2]|=o.charCodeAt(e)<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(S(t,a),e=0;e<16;e+=1)a[e]=0;return y=s*8,y=y.toString(16).match(/(.*?)(.{0,8})$/),m=parseInt(y[2],16),b=parseInt(y[1],16)||0,a[14]=m,a[15]=b,S(t,a),t}function X(o){var s=o.length,t=[1732584193,-271733879,-1732584194,271733878],e,n,a,y,m,b;for(e=64;e<=s;e+=64)S(t,j(o.subarray(e-64,e)));for(o=e-64<s?o.subarray(e-64):new Uint8Array(0),n=o.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)a[e>>2]|=o[e]<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(S(t,a),e=0;e<16;e+=1)a[e]=0;return y=s*8,y=y.toString(16).match(/(.*?)(.{0,8})$/),m=parseInt(y[2],16),b=parseInt(y[1],16)||0,a[14]=m,a[15]=b,S(t,a),t}function te(o){var s="",t;for(t=0;t<4;t+=1)s+=F[o>>t*8+4&15]+F[o>>t*8&15];return s}function T(o){var s;for(s=0;s<o.length;s+=1)o[s]=te(o[s]);return o.join("")}T(ee("hello")),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function o(s,t){return s=s|0||0,s<0?Math.max(s+t,0):Math.min(s,t)}ArrayBuffer.prototype.slice=function(s,t){var e=this.byteLength,n=o(s,e),a=e,y,m,b,Q;return t!==$&&(a=o(t,e)),n>a?new ArrayBuffer(0):(y=a-n,m=new ArrayBuffer(y),b=new Uint8Array(m),Q=new Uint8Array(this,n,y),b.set(Q),m)}}();function z(o){return/[\u0080-\uFFFF]/.test(o)&&(o=unescape(encodeURIComponent(o))),o}function ae(o,s){var t=o.length,e=new ArrayBuffer(t),n=new Uint8Array(e),a;for(a=0;a<t;a+=1)n[a]=o.charCodeAt(a);return s?n:e}function H(o){return String.fromCharCode.apply(null,new Uint8Array(o))}function q(o,s,t){var e=new Uint8Array(o.byteLength+s.byteLength);return e.set(new Uint8Array(o)),e.set(new Uint8Array(s),o.byteLength),e}function E(o){var s=[],t=o.length,e;for(e=0;e<t-1;e+=2)s.push(parseInt(o.substr(e,2),16));return String.fromCharCode.apply(String,s)}function g(){this.reset()}return g.prototype.append=function(o){return this.appendBinary(z(o)),this},g.prototype.appendBinary=function(o){this._buff+=o,this._length+=o.length;var s=this._buff.length,t;for(t=64;t<=s;t+=64)S(this._hash,G(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},g.prototype.end=function(o){var s=this._buff,t=s.length,e,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],a;for(e=0;e<t;e+=1)n[e>>2]|=s.charCodeAt(e)<<(e%4<<3);return this._finish(n,t),a=T(this._hash),o&&(a=E(a)),this.reset(),a},g.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},g.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},g.prototype.setState=function(o){return this._buff=o.buff,this._length=o.length,this._hash=o.hash,this},g.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},g.prototype._finish=function(o,s){var t=s,e,n,a;if(o[t>>2]|=128<<(t%4<<3),t>55)for(S(this._hash,o),t=0;t<16;t+=1)o[t]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(e[2],16),a=parseInt(e[1],16)||0,o[14]=n,o[15]=a,S(this._hash,o)},g.hash=function(o,s){return g.hashBinary(z(o),s)},g.hashBinary=function(o,s){var t=ee(o),e=T(t);return s?E(e):e},g.ArrayBuffer=function(){this.reset()},g.ArrayBuffer.prototype.append=function(o){var s=q(this._buff.buffer,o),t=s.length,e;for(this._length+=o.byteLength,e=64;e<=t;e+=64)S(this._hash,j(s.subarray(e-64,e)));return this._buff=e-64<t?new Uint8Array(s.buffer.slice(e-64)):new Uint8Array(0),this},g.ArrayBuffer.prototype.end=function(o){var s=this._buff,t=s.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n,a;for(n=0;n<t;n+=1)e[n>>2]|=s[n]<<(n%4<<3);return this._finish(e,t),a=T(this._hash),o&&(a=E(a)),this.reset(),a},g.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},g.ArrayBuffer.prototype.getState=function(){var o=g.prototype.getState.call(this);return o.buff=H(o.buff),o},g.ArrayBuffer.prototype.setState=function(o){return o.buff=ae(o.buff,!0),g.prototype.setState.call(this,o)},g.ArrayBuffer.prototype.destroy=g.prototype.destroy,g.ArrayBuffer.prototype._finish=g.prototype._finish,g.ArrayBuffer.hash=function(o,s){var t=X(new Uint8Array(o)),e=T(t);return s?E(e):e},g})})(Ue);var $t=Ue.exports;const Ft=lt($t);function jt(...P){const I=[];return P.forEach(F=>{if(F){const{cleanup:S}=ut(F);I.push(S)}}),Ie(()=>{I.forEach(F=>F())}),{cleanup:()=>{I.forEach(F=>F())}}}function Be(P){return jt(P)}const Tt={class:"upload-page-container"},xt={class:"main-container"},Bt={class:"upload-content",style:{position:"relative"}},Et={key:0,class:"simple-loading-overlay"},It={class:"loading-content"},Ut={class:"progress-text"},Lt={class:"upload-icon"},Nt={class:"tag-selector-container"},Mt={class:"upload-progress-container"},Dt={class:"stat-item",style:{width:"50%"}},Rt={class:"stat-value"},Ot={class:"stat-item",style:{width:"50%"}},Jt={class:"success-value"},Pt={class:"upload-progress"},zt={key:1,class:"empty-progress"},Ht={class:"upload-actions"},Vt={class:"right-sidebar"},Wt=["innerHTML"],Kt={key:1},Ee="application/json",Gt=it({__name:"UploadSample",setup(P){const I=ct(),{currentProject:$}=ft(I),F=me(()=>{var r;return(r=$.value)==null?void 0:r.id}),S=me(()=>{var r;return(r=$.value)==null?void 0:r.type}),G=me(()=>{var r;return((r=$.value)==null?void 0:r.image_type)||0}),j=dt(),ee=St(),X=v([]),te=gt(),T=v([]),z=v(0),ae=v(0),H=v(0),q=v(0),E=v(0),g=v(0),o=v(0),s=v(0),t=v(0),e=v(0),n=v(),a=v(!1),y=v([]),m=v(!1);let b=null;Be(a);const{on:Q,off:ye}=pt(),ne=()=>{m.value=!0,b&&(b.abort(),b=null),p("由于登录状态失效，上传已中断"),w.value&&(w.value=!1,p("由于登录状态失效，文件处理已中断"),n.value&&(n.value.value=""),U.value=0,V.value=0,N.value="")};Q(ue.TOKEN_EXPIRED,ne),Q(ue.TOKEN_CONFLICT,ne);let se=null;const re=v("color"),ce=v(!1),Le=v(null),Z=v([]),oe=v(null),w=v(!1),N=v(""),U=v(0),V=v(0);Be(w);const M=v(new Map),x=v([]),A=v([]),Ne=["image/jpeg","image/jpg","image/png","image/bmp"],W=v(new Map),fe=v(null),de=v(null),Me=()=>{!w.value&&n.value&&n.value.click()},De=r=>{r.preventDefault()},Re=r=>{var u;if(r.preventDefault(),w.value)return;const l=Array.from(((u=r.dataTransfer)==null?void 0:u.files)||[]);l.length>0&&be(l)},Oe=r=>{const l=r.target,u=Array.from(l.files||[]);u.length>0&&be(u)},be=async r=>{if(m.value){p("登录状态已失效，无法处理文件");return}w.value=!0,V.value=r.length,U.value=0,N.value=`开始处理 ${r.length} 个文件...`,await je(),x.value=[],A.value=[],T.value=[],W.value.clear(),M.value.clear();const l=10;for(let u=0;u<r.length;u+=l){const f=r.slice(u,u+l);for(const i of f)await Je(i),U.value++,N.value=`正在处理文件... (${U.value}/${V.value})`;await new Promise(i=>setTimeout(i,10))}if(await tt(),m.value){p(`文件处理已中断：共处理 ${U.value} 个文件`),w.value=!1;return}We(),z.value=x.value.length,Xe(),N.value="文件处理完成！",setTimeout(()=>{w.value=!1},500)},Je=async r=>{if(!Ne.includes(r.type)&&r.type!==Ee){p(`不支持的文件类型: ${r.name}，仅支持jpeg/jpg、png、bmp和json格式`);return}if(r.type===Ee){if(r.name==="label.json"){fe.value=r;return}if(r.name==="background.json"){de.value=r;return}if(!A.value.some(l=>l.name===r.name)){A.value.push(r);try{const l=await Pe(r),u=JSON.parse(l);r.labelList=ze(u)}catch{p(`解析JSON文件 ${r.name} 失败`)}}return}try{await Ke(r)}catch{p(`处理图片 ${r.name} 时出错`)}},Pe=r=>new Promise((l,u)=>{const f=new FileReader;f.onload=i=>{var d;return l((d=i.target)==null?void 0:d.result)},f.onerror=()=>u(new Error("读取文件失败")),f.readAsText(r)}),ze=r=>{const l=new Set;if(S.value==="分类")r.classfication&&l.add(r.classfication.labelName);else for(const u of Object.keys(r))Array.isArray(r[u])&&r[u].forEach(f=>{f.labelName&&l.add(f.labelName)});return Array.from(l)},He=()=>{w.value=!1,n.value&&(n.value.value=""),x.value=[],A.value=[],T.value=[],z.value=0,W.value.clear(),M.value.clear(),U.value=0,V.value=0,N.value="",p("文件处理已取消")},_e=r=>{if(a.value){const l="上传正在进行中，刷新页面将中断上传进程。是否确定要离开？";return r.preventDefault(),r.returnValue=l,l}},Ve=()=>{window.addEventListener("beforeunload",_e)},pe=()=>{window.removeEventListener("beforeunload",_e)},We=()=>{if(x.value.length===0)return;const r=new Map,l=new Map,u=new Set;if(A.value.length>0)for(const f of A.value){if(!f)continue;const i=f.name;let d="";if(i.endsWith(".mix.json"))d=i.substring(0,i.lastIndexOf(".mix.json"));else if(i.endsWith(".json"))d=i.substring(0,i.lastIndexOf(".json"));else{console.warn(`未知的JSON文件格式: ${i}`);continue}l.set(d,f)}for(const f of x.value){if(!f)continue;const i=f.name.substring(0,f.name.lastIndexOf(".")),d=l.get(i)||null;r.set(i,{image:f,json:d}),d&&u.add(i)}for(const[f,i]of l.entries())u.has(f)||r.has(f)||(r.set(f,{image:null,json:i}),p(`警告：${f} 只有JSON文件，缺少对应的图片文件`));M.value=r},Ke=async r=>{try{const l=await we(r);if(Array.from(W.value.keys()).includes(l)){const u=W.value.get(l);p(`发现重复图片: ${r.name}，与 ${u} 内容相同，已丢弃`),E.value++,Ge(r.name);return}x.value.push(r),W.value.set(l,r.name)}catch(l){if(l.message==="MD5计算被中断")return;console.error(`处理图片 ${r.name} 时出错:`,l)}},Ge=r=>{const l=r.substring(0,r.lastIndexOf(".")),u=A.value.findIndex(f=>{let i="";const d=f.name;return d.endsWith(".mix.json")?i=d.substring(0,d.lastIndexOf(".mix.json")):d.endsWith(".json")&&(i=d.substring(0,d.lastIndexOf(".json"))),i===l});if(u!==-1){const f=A.value[u];A.value.splice(u,1),p(`同时移除对应的JSON文件: ${f.name}`);const i=T.value.findIndex(d=>d.name===f.name);i!==-1&&T.value.splice(i,1)}},K=v(new Set),ve=()=>{K.value.forEach(r=>{try{r.abort()}catch{}}),K.value.clear()},we=r=>new Promise((l,u)=>{const f=File.prototype.slice,i=2097152,d=Math.ceil(r.size/i);let c=0;const _=new Ft.ArrayBuffer,C=new FileReader;K.value.add(C),C.onload=R=>{if(m.value){K.value.delete(C),u(new Error("MD5计算被中断"));return}if(_.append(R.target.result),c++,c<d)D();else{const ge=_.end();K.value.delete(C),l(ge)}},C.onerror=R=>{K.value.delete(C),u(R)};function D(){const R=c*i,ge=R+i>=r.size?r.size:R+i;C.readAsArrayBuffer(f.call(r,R,ge))}D()}),Xe=()=>{if(x.value.length>0){const r=x.value.length===1?`已选择 1 张图片: ${x.value[0].name}`:`已选择 ${x.value.length} 张图片`;A.value.length>0?he(`${r}, ${A.value.length} 个JSON文件`):he(r)}else A.value.length>0&&he(`已选择 ${A.value.length} 个JSON文件，没有选择图片`)},he=r=>{const l=Z.value.findIndex(u=>u.startsWith("已选择"));l!==-1?Z.value[l]=r:Z.value.unshift(r)},qe=()=>{const r=[];for(const[l,u]of M.value.entries())u.image&&r.push(u.image);return r},Qe=()=>{var l;return Array.from(M.value.values()).some(u=>u.image!==null)?(l=$.value)!=null&&l.id?!0:(p("请先选择项目"),!1):(p("请先选择要上传的文件"),!1)},Ze=async r=>{if(m.value)return!1;if(!r)return p("文件对象无效，跳过此文件"),!1;const l=await we(r),u=new FormData;u.append("name",r.name),u.append("md5",l),u.append("project_id",String($.value.id)),u.append("file",r);const f=r.name.substring(0,r.name.lastIndexOf(".")),i=M.value.get(f);if(i!=null&&i.json){const d=i.json,c=d.labelList;u.append("annotation_file",d),c&&Array.isArray(c)&&c.length>0&&u.append("label_names",c.join(","))}y.value.length!==0&&u.append("tag_names",y.value.join(","));try{const d=await wt(u,b==null?void 0:b.signal);if(d.data.code===200)return p(`${r.name} 上传成功`),Le.value=d.data.data.id.toString(),I.setHasSampleImage(!0),!0;{const c=d.data.msg||"";return c.includes("已存在")||c.includes("重复")||c.includes("exist")?(o.value++,p(`${r.name} 上传失败: 文件已存在`)):c.includes("格式")||c.includes("format")||c.includes("类型")?(t.value++,p(`${r.name} 上传失败: 格式错误 - ${c}`)):(e.value++,p(`${r.name} 上传失败: ${c}`)),!1}}catch(d){if(d.name==="AbortError"||d.code==="ERR_CANCELED"||m.value)return!1;const c=d.message||"";return c.includes("网络")||c.includes("network")||c.includes("timeout")||d.code==="NETWORK_ERROR"?(s.value++,p(`${r.name} 上传出错: 网络错误`)):(e.value++,p(`${r.name} 上传出错: ${c}`)),!1}},Ye=()=>{se=te.beforeEach((r,l,u)=>{const f=j.isUploading,i=j.showUploadingTip,d=f&&i||w.value;if(l.path.includes("/sample/upload")&&d&&!m.value){const c=w.value?"当前正在处理文件，离开页面将中断处理。是否确认离开？":"当前有上传任务正在进行中，离开页面将中断上传。是否确认离开？";Te.confirm(c,"提示",{confirmButtonText:"确认离开",cancelButtonText:"取消",type:"warning"}).then(()=>{m.value=!0,w.value&&(ve(),w.value=!1),le(!1),u()}).catch(()=>{u(!1)})}else m.value&&le(!1),u()})},ke=()=>{se&&(se(),se=null)},le=(r=!0)=>{a.value=!1,w.value&&(ve(),w.value=!1,U.value=0,V.value=0,N.value=""),r&&(m.value=!1),b&&(b=null),j.clearUploadingStatus(),j.clearShowUploadingTip(),H.value=0,x.value=[],A.value=[],W.value.clear(),M.value.clear(),T.value=[],q.value=0,E.value=0,g.value=0,o.value=0,s.value=0,t.value=0,e.value=0,n.value&&(n.value.value=""),p("文件列表已重置，可以继续上传新文件")},et=()=>{m.value=!1},tt=async()=>{try{await mt()}catch(r){console.error("检查token状态时出错:",r)}},at=async()=>{try{const r=await ee.fetchTags(F.value);X.value=r.tags||[]}catch(r){console.error("获取项目标签失败:",r),X.value=[]}},nt=async()=>{var r;if(fe.value)try{const l=new FileReader,u=await new Promise((c,_)=>{l.onload=C=>{var D;return c((D=C.target)==null?void 0:D.result)},l.onerror=C=>_(C),l.readAsText(fe.value)}),f=JSON.parse(u);if(!Array.isArray(f)){p("label.json 格式错误，应为标签数组");return}const i=f.map(c=>({name:c.name,color:c.color||[255,0,0,255]}));if(i.length===0){p("label.json 中没有有效的标签数据");return}const d=await At({project_id:Number(((r=$.value)==null?void 0:r.id)||0),labels:i});d.data.code===200?p("成功创建类别"):p(`创建类别失败: ${d.data.msg}`)}catch(l){p(`处理 label.json 文件失败: ${l.message}`)}},st=async()=>{var l;if(!Qe())return;if(y.value.length===0)try{await Te.confirm('<span style="color: #E6A23C; font-weight: bold;">未添加标签</span>，是否继续上传？',"提示",{confirmButtonText:"继续上传",cancelButtonText:"先添加标签",type:"warning",distinguishCancelAndClose:!0,dangerouslyUseHTMLString:!0})}catch(u){if(u==="cancel"){p("已取消上传，请添加标签后重新上传");return}return}if(m.value){p("登录状态已失效，无法开始上传，请重新登录");return}m.value=!1,b=new AbortController,a.value=!0,j.setUploadingStatus(!0),j.setShowUploadingTip(!0),Ve();let r=0;try{await nt();const u=qe(),f=u.length;if(f===0){p("当前没有可上传的图像"),a.value=!1,j.clearUploadingStatus(),j.clearShowUploadingTip(),pe();return}p(`开始上传 ${f} 个图像`);for(const[c,_]of u.entries()){if(m.value){p(`上传已中断：共处理 ${c} 张图片，成功 ${r} 张`);break}await Ze(_)&&(r++,ae.value=r);const D=Math.floor((c+1)/f*100);H.value=Math.min(D,100)}if(de.value&&!m.value){const c=new FormData;c.append("project_id",String(((l=$.value)==null?void 0:l.id)||0)),c.append("file",de.value),await _t(c,b==null?void 0:b.signal)}r>0&&I.setHasSampleImage(!0);const i=o.value+s.value+t.value+e.value;let d=`📊 上传统计：总共${f}张，成功${r}张，失败${i}张`;if(i>0){const c=[];o.value>0&&c.push(`已存在${o.value}张`),s.value>0&&c.push(`网络错误${s.value}张`),t.value>0&&c.push(`格式错误${t.value}张`),e.value>0&&c.push(`其他错误${e.value}张`),c.length>0&&(d+=`（${c.join("，")}）`)}E.value>0&&(d+=`，重复${E.value}张`),q.value>0&&(d+=`，过滤器不匹配${q.value}张`),p(d,"statistics")}catch(u){u.name==="AbortError"||u.code==="ERR_CANCELED"?p("上传已被中断"):(p(`上传过程中发生错误: ${u.message}`),console.error("Upload error:",u))}finally{a.value&&(pe(),le())}},rt=r=>{if(typeof r=="object"&&r.type)return r.type;const l=typeof r=="string"?r:r.message;return l.includes("成功")||l.includes("已选择")?"success":l.includes("警告")||l.includes("重复")?"warning":l.includes("失败")||l.includes("错误")||l.includes("不匹配")||l.includes("重复")||l.includes("不支持")||l.includes("当前选择的是")&&l.includes("图像过滤器")?"error":""},ot=r=>r.replace(/成功(\d+)张/g,'<span style="color: #67C23A; font-weight: bold;">成功$1张</span>').replace(/失败(\d+)张/g,'<span style="color: #F56C6C; font-weight: bold;">失败$1张</span>').replace(/已存在(\d+)张/g,'<span style="color: #FF6B35; font-weight: bold;">已存在$1张</span>').replace(/网络错误(\d+)张/g,'<span style="color: #FF4757; font-weight: bold;">网络错误$1张</span>').replace(/格式错误(\d+)张/g,'<span style="color: #FF6348; font-weight: bold;">格式错误$1张</span>').replace(/其他错误(\d+)张/g,'<span style="color: #FF5722; font-weight: bold;">其他错误$1张</span>').replace(/重复(\d+)张/g,'<span style="color: #E6A23C; font-weight: bold;">重复$1张</span>').replace(/过滤器不匹配(\d+)张/g,'<span style="color: #E6A23C; font-weight: bold;">过滤器不匹配$1张</span>'),p=(r,l)=>{const u=l?{message:r,type:l}:r;Z.value.push(u),je(()=>{oe.value&&(oe.value.scrollTop=oe.value.scrollHeight)})};return Se(re,(r,l)=>{r!==l&&p(`已切换到${r==="color"?"彩色":"灰度"}图像模式`)}),vt(()=>{et(),re.value="color",ce.value=!1,Number(G.value)===1?(re.value="gray",ce.value=!0):Number(G.value)===3&&(re.value="color",ce.value=!0),F.value&&at(),Ye()}),Ie(()=>{ke(),pe(),ye(ue.TOKEN_EXPIRED,ne),ye(ue.TOKEN_CONFLICT,ne),(a.value||w.value)&&(m.value=!0,w.value&&ve(),le(!1))}),Se(()=>te.currentRoute.value.path,()=>{}),(r,l)=>{const u=k("el-icon"),f=k("el-button"),i=k("el-option"),d=k("el-select"),c=k("el-progress");return B(),L("div",Tt,[h("div",xt,[l[7]||(l[7]=h("div",{class:"tab-title"},[h("div",{class:"title-content"},[h("span",null,"图像上传")])],-1)),h("div",Bt,[w.value?(B(),L("div",Et,[h("div",It,[O(u,{class:"is-loading",size:"24"},{default:Y(()=>[O(xe(yt))]),_:1}),h("p",null,J(N.value),1),h("p",Ut,J(U.value)+"/"+J(V.value),1),O(f,{onClick:He,link:"",size:"small",style:{"margin-top":"12px"}},{default:Y(()=>l[1]||(l[1]=[ie(" 取消处理 ")])),_:1})])])):ht("",!0),h("div",{class:Ae(["upload-area",{processing:w.value}])},[h("div",{class:"upload-drop-area",onClick:Me,onDrop:Re,onDragover:De},[h("input",{ref_key:"fileInputRef",ref:n,type:"file",multiple:"",accept:"image/*,.json",onChange:Oe,style:{display:"none"}},null,544),h("div",Lt,[O(u,null,{default:Y(()=>[O(xe(bt))]),_:1})]),l[2]||(l[2]=h("div",{class:"upload-text"},[h("p",null,[ie("将图像拖拽到此处，或者"),h("span",{class:"highlight"},"点击此处"),ie("选择文件或文件夹")]),h("p",{class:"upload-format"},"支持的图像格式为: jpeg/jpg、png、bmp，单张图像大小不超过20M"),h("p",{class:"upload-tip"},"💡 提示：无论彩色或灰度图像，系统将统一按彩色模式进行训练处理")],-1))],32),h("div",Nt,[l[3]||(l[3]=h("div",{class:"tag-selector-label"},"文件标签",-1)),O(d,{modelValue:y.value,"onUpdate:modelValue":l[0]||(l[0]=_=>y.value=_),multiple:"",clearable:"",filterable:"","allow-create":"","max-collapse-tags":3,"collapse-tags":"",placeholder:"选择或创建标签",class:"tag-selector"},{default:Y(()=>[(B(!0),L($e,null,Fe(X.value,_=>(B(),Ce(i,{key:_.id,label:_.name,value:_.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),h("div",Mt,[h("div",Dt,[l[4]||(l[4]=h("span",{class:"stat-label"},"当次选中样本数",-1)),h("span",Rt,J(z.value),1)]),h("div",Ot,[l[5]||(l[5]=h("span",{class:"stat-label"},"成功上传样本数",-1)),h("span",Jt,J(ae.value),1)])]),h("div",Pt,[H.value>0?(B(),Ce(c,{key:0,percentage:H.value,"stroke-width":10,"show-text":!1},null,8,["percentage"])):(B(),L("div",zt))]),h("div",Ht,[O(f,{type:"primary",class:"upload-button",onClick:st,loading:a.value,disabled:a.value},{default:Y(()=>[ie(J(a.value?"上传中...":"上传"),1)]),_:1},8,["loading","disabled"])])],2)]),h("div",Vt,[l[6]||(l[6]=h("div",{class:"sidebar-header"},"上传日志",-1)),h("div",{class:"log-content",ref_key:"logContent",ref:oe},[(B(!0),L($e,null,Fe(Z.value,(_,C)=>(B(),L("div",{class:Ae(["log-item",rt(_)]),key:C},[typeof _=="object"&&_.type==="statistics"?(B(),L("span",{key:0,innerHTML:ot(_.message)},null,8,Wt)):(B(),L("span",Kt,J(typeof _=="string"?_:_.message),1))],2))),128))],512)])])])}}}),Yt=Ct(Gt,[["__scopeId","data-v-ad3922c8"]]);export{Yt as default};
//# sourceMappingURL=UploadSample-BFIOmAMt.js.map
