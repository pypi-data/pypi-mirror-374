when:
  - event: push
  - event: pull_request

clone:
  git:
    image: woodpeckerci/plugin-git:2.6
    settings:
      tags: true
      partial: false

steps:
  - name: tagging
    image: mcp/git:latest
    commands:
      - git describe --tags | tee .tag

  - name: credential
    image: python:3.12
    commands:
      - echo AWS_ACCESS_KEY_ID=$${AWS_ACCESS_KEY_ID} >> .env
      - echo AWS_SECRET_ACCESS_KEY=$${AWS_SECRET_ACCESS_KEY} >> .env
      - cat .env
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: minio_access_key
      AWS_SECRET_ACCESS_KEY:
        from_secret: minio_secret_key
    when:
      - event: push

  - name: credential
    image: python:3.12
    commands:
      - echo AWS_ACCESS_KEY_ID=$${AWS_ACCESS_KEY_ID} >> .env
      - echo AWS_SECRET_ACCESS_KEY=$${AWS_SECRET_ACCESS_KEY} >> .env
      - cat .env
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: readonly_minio_access_key
      AWS_SECRET_ACCESS_KEY:
        from_secret: readonly_minio_secret_key
    when:
      - event: pull_request

  - name: docker
    image: woodpeckerci/plugin-docker-buildx:6-insecure
    settings:
      repo: git.kclab.cloud/hzhangxyz/qmb
      username: hzhangxyz
      password:
        from_secret: gitea_package
      registry: git.kclab.cloud
      tags_file: .tag
      cache-to: type=s3,bucket=cache-53030,region=local,endpoint_url=https://s3.kclab.cloud,prefix=${CI_REPO}/docker/,mode=max
      cache-from:
        - type=s3\\,bucket=cache-53030\\,region=local\\,endpoint_url=https://s3.kclab.cloud\\,prefix=${CI_REPO}/docker/
      env_file: .env
      buildkit_config: |
        [registry."docker.io"]
        mirrors = ["https://docker.mirrors.kclab.cloud/"]
      build_args:
        PYPI_MIRROR: https://mirrors.ustc.edu.cn/pypi/simple
    when:
      - event: push

  - name: docker
    image: woodpeckerci/plugin-docker-buildx:6-insecure
    settings:
      repo: git.kclab.cloud/hzhangxyz/qmb
      dry_run: true
      tags_file: .tag
      cache-from:
        - type=s3\\,bucket=cache-53030\\,region=local\\,endpoint_url=https://s3.kclab.cloud\\,prefix=${CI_REPO}/docker/
      env_file: .env
      buildkit_config: |
        [registry."docker.io"]
        mirrors = ["https://docker.mirrors.kclab.cloud/"]
      build_args:
        PYPI_MIRROR: https://mirrors.ustc.edu.cn/pypi/simple
    when:
      - event: pull_request
