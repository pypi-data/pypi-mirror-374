when:
  - event: push
  - event: pull_request

variables:
  - &pip_config
    PIP_INDEX_URL: https://mirrors.ustc.edu.cn/pypi/simple
  - &repo_config
    TWINE_REPOSITORY_URL: https://git.kclab.cloud/api/packages/hzhangxyz/pypi
    TWINE_USERNAME: hzhangxyz
    TWINE_PASSWORD:
      from_secret: gitea_package

clone:
  git:
    image: woodpeckerci/plugin-git:2.6
    settings:
      tags: true
      partial: false

steps:
  - name: build
    image: python:3.12
    environment:
      <<: *pip_config
    commands:
      - pip install pipx
      - pipx run build

  - name: upload
    image: python:3.12
    environment:
      <<: [*pip_config, *repo_config]
    commands:
      - pip install pipx
      - pipx run twine upload dist/* --verbose
    when:
      event: push
