when:
  - event: push
  - event: pull_request

variables:
  - &pip_config
    PIP_INDEX_URL: https://mirrors.ustc.edu.cn/pypi/simple
  - &pre_commit_config
    PRE_COMMIT_HOME: /woodpecker/cache/pre-commit
  - &minio_config
    MINIO_HOST: https://s3.kclab.cloud
    MINIO_BUCKET: cache-53030

steps:
  - name: open cache
    image: minio/mc:latest
    environment:
      <<: [*pre_commit_config, *minio_config]
      MINIO_ACCESS_KEY:
        from_secret: readonly_minio_access_key
      MINIO_SECRET_KEY:
        from_secret: readonly_minio_secret_key
    commands:
      - mkdir --parents $${PRE_COMMIT_HOME}
      - touch $${PRE_COMMIT_HOME}/.keep
      - mc alias set minio $${MINIO_HOST} $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY}
      - mc cp --recursive minio/$${MINIO_BUCKET}/${CI_REPO}/pre-commit/ $${PRE_COMMIT_HOME}/
    failure: ignore

  - name: pre-commit
    image: python:3.12
    environment:
      <<: [*pre_commit_config, *pip_config]
    commands:
      - pip install pre-commit
      - pip install '.[dev]'
      - pre-commit run --all-files

  - name: save cache
    image: minio/mc:latest
    environment:
      <<: [*pre_commit_config, *minio_config]
      MINIO_ACCESS_KEY:
        from_secret: minio_access_key
      MINIO_SECRET_KEY:
        from_secret: minio_secret_key
    commands:
      - mc alias set minio $${MINIO_HOST} $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY}
      - mc cp --recursive $${PRE_COMMIT_HOME}/ minio/$${MINIO_BUCKET}/${CI_REPO}/pre-commit/
    when:
      event: push
