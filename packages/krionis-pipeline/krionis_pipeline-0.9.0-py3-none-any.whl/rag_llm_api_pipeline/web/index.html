<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>KRIONIS pipeline</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --bg:#f7f7f8; --card:#ffffff; --text:#111; --muted:#666; --accent:#0f62fe; }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:16px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;
    display:flex; align-items:center; justify-content:center; min-height:100vh;
  }
  .wrap{ width:100%; max-width:820px; padding:24px; }
  .card{
    background:var(--card); border:1px solid #e5e7eb; border-radius:12px;
    padding:24px; box-shadow:0 1px 2px rgba(0,0,0,.03);
  }
  h1{margin:0 0 12px; font-size:22px}
  p.sub{margin:0 0 20px; color:var(--muted)}
  label{display:block; font-weight:600; margin:14px 0 6px}
  input, textarea{
    width:100%; border:1px solid #d1d5db; border-radius:10px; padding:12px 14px;
    font:inherit; outline:none; background:#fff;
  }
  textarea{min-height:120px; resize:vertical}
  button{
    margin-top:14px; background:var(--accent); color:#fff; border:0; border-radius:10px;
    padding:12px 16px; font-weight:600; cursor:pointer;
  }
  #answer, #stats, #chunks{
    margin-top:18px; white-space:pre-wrap; background:#fafafa; border:1px solid #eee;
    border-radius:10px; padding:14px;
  }
  #stats, #chunks{ color:#333; font-size:14px }
  .row{display:flex; gap:12px}
  .row > div{flex:1}
  .spinner{
    margin-top:12px; display:none; align-items:center; gap:8px; color:#555;
  }
  .spinner .dot{
    width:8px; height:8px; border-radius:50%; background:#999; animation:b 1.2s infinite ease-in-out;
  }
  .spinner .dot:nth-child(2){ animation-delay:.2s }
  .spinner .dot:nth-child(3){ animation-delay:.4s }
  @keyframes b { 0%,80%,100%{transform:scale(0)} 40%{transform:scale(1)} }
  code.kv{background:#fff; border:1px solid #eee; padding:2px 6px; border-radius:6px}
  ul.meta{margin:8px 0 0 18px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>KRIONIS-PIPELINE</h1>
      <p class="sub">Ask. Retrieve. Answer. Timings & token speed included.</p>

      <div class="row">
        <div>
          <label for="system">System</label>
          <input id="system" value="TestSystem" />
        </div>
      </div>

      <label for="question">Question</label>
      <textarea id="question" placeholder="Type your question and press Enter or click Submit"></textarea>

      <button id="submit">Submit</button>

      <div class="spinner" id="spinner">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        <span id="spinner-text">Thinking…</span>
      </div>

      <div id="answer" style="display:none"></div>
      <div id="stats" style="display:none"></div>
      <div id="chunks" style="display:none"></div>
    </div>
  </div>

<script>
  const ans = document.getElementById("answer");
  const statsBox = document.getElementById("stats");
  const chunksBox = document.getElementById("chunks");
  const spin = document.getElementById("spinner");
  const spinText = document.getElementById("spinner-text");
  let timerInterval;

  async function send() {
    const system = document.getElementById("system").value.trim();
    const question = document.getElementById("question").value.trim();
    if(!system || !question){
      ans.style.display="block"; ans.textContent = "Please enter both System and Question.";
      return;
    }
    ans.style.display="none"; statsBox.style.display="none"; chunksBox.style.display="none";
    spin.style.display="flex";

    // Start timer
    let seconds = 0;
    spinText.textContent = "Thinking… 0s";
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      seconds++;
      spinText.textContent = `Thinking… ${seconds}s`;
    }, 1000);

    try{
      const res = await fetch("/query", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ system, question })
      });
      const json = await res.json();
      spin.style.display="none";
      clearInterval(timerInterval);

      ans.style.display="block";
      ans.textContent = json.answer || "No answer.";

      // Stats
      if(json.stats){
        const parts = [];
        if(typeof json.stats.query_time_sec === "number"){
          parts.push(`<code class="kv">Query Time: ${json.stats.query_time_sec}s</code>`);
        }
        if(typeof json.stats.tokens_per_sec === "number"){
          const tps = json.stats.tokens_per_sec.toFixed(2);
          const toks = json.stats.gen_tokens ?? "?";
          const gt = json.stats.gen_time_sec ?? "?";
          parts.push(`<code class="kv">Token Speed: ${tps} tok/s (${toks} in ${gt}s)</code>`);
        }
        if(json.stats.retrieval){
          const r = json.stats.retrieval;
          parts.push(`<code class="kv">Retrieval: embed=${r.embed_query_sec}s, search=${r.faiss_search_sec}s, stitch=${r.context_stitch_sec}s</code>`);
        }
        if(parts.length){
          statsBox.style.display="block";
          statsBox.innerHTML = parts.join(" ");
        }
      }

      // Sources or Chunks
      if (Array.isArray(json.sources) && json.sources.length) {
        chunksBox.style.display="block";
        const lis = json.sources
          .map((src, i) => `<li>[${i+1}] ${src.slice(0, 240)}…</li>`)
          .join("");
        chunksBox.innerHTML = `<strong>Sources</strong><ul class="meta">${lis}</ul>`;
      } else if (json.stats && Array.isArray(json.stats.chunks_meta) && json.stats.chunks_meta.length) {
        chunksBox.style.display="block";
        const lis = json.stats.chunks_meta
          .map(m => `<li>#${m.rank} (idx=${m.index}) · ${m.char_len} chars</li>`)
          .join("");
        chunksBox.innerHTML = `<strong>Retrieved Chunks</strong><ul class="meta">${lis}</ul>`;
      }

    }catch(err){
      spin.style.display="none";
      clearInterval(timerInterval);
      ans.style.display="block";
      ans.textContent = "Error: "+ err.message;
    }
  }

  document.getElementById("submit").addEventListener("click", send);
  document.getElementById("question").addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }
  });
</script>
</body>
</html>
