name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool
      
      - name: Download EMBOSS
        run: |
          wget ftp://emboss.open-bio.org/pub/EMBOSS/EMBOSS-6.6.0.tar.gz
          tar -xzf EMBOSS-6.6.0.tar.gz
      
      - name: Apply patch and build
        run: |
          cd EMBOSS-6.6.0
          patch -p1 < ../einverted.patch
          ./configure --without-x --without-pngdriver
          cd emboss
          make einverted
          cp .libs/einverted ../einverted-linux-x86_64
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: einverted-linux-x86_64
          path: EMBOSS-6.6.0/einverted-linux-x86_64

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          brew install autoconf automake libtool
      
      - name: Download EMBOSS
        run: |
          curl -L -o EMBOSS-6.6.0.tar.gz ftp://emboss.open-bio.org/pub/EMBOSS/EMBOSS-6.6.0.tar.gz
          tar -xzf EMBOSS-6.6.0.tar.gz
      
      - name: Apply patch and build
        run: |
          cd EMBOSS-6.6.0
          patch -p1 < ../einverted.patch
          ./configure --without-x --without-pngdriver
          cd emboss
          make einverted
          cp .libs/einverted ../einverted-macos-x86_64
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: einverted-macos-x86_64
          path: EMBOSS-6.6.0/einverted-macos-x86_64

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          brew install autoconf automake libtool
      
      - name: Download EMBOSS
        run: |
          curl -L -o EMBOSS-6.6.0.tar.gz ftp://emboss.open-bio.org/pub/EMBOSS/EMBOSS-6.6.0.tar.gz
          tar -xzf EMBOSS-6.6.0.tar.gz
      
      - name: Apply patch and build for ARM64
        run: |
          cd EMBOSS-6.6.0
          patch -p1 < ../einverted.patch
          # Cross-compile for ARM64
          ./configure --without-x --without-pngdriver --host=arm64-apple-darwin
          cd emboss
          make einverted CFLAGS="-target arm64-apple-darwin"
          cp .libs/einverted ../einverted-macos-arm64
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: einverted-macos-arm64
          path: EMBOSS-6.6.0/einverted-macos-arm64

  release:
    needs: [build-linux, build-macos, build-macos-arm64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Create install script
        run: |
          cp install.sh install-dsrnascan.sh
          chmod +x install-dsrnascan.sh
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            einverted-linux-x86_64/einverted-linux-x86_64
            einverted-macos-x86_64/einverted-macos-x86_64
            einverted-macos-arm64/einverted-macos-arm64
            install-dsrnascan.sh
            dsRNAscan.py
          body: |
            ## Installation
            
            ### Quick install (recommended):
            ```bash
            curl -L https://github.com/Bass-Lab/dsRNAscan/releases/download/${{ github.ref_name }}/install-dsrnascan.sh | bash
            ```
            
            ### Manual install:
            1. Download the appropriate einverted binary for your platform
            2. Download dsRNAscan.py
            3. Make both executable and add to your PATH
            
            ### Supported platforms:
            - Linux x86_64
            - macOS x86_64 (Intel)
            - macOS ARM64 (Apple Silicon)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}